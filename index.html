<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Con-bridge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- NUOVO DESIGN SYSTEM v4 (Stile App Nativa) --- */

        /* 1. Variabili e Stili di Base */
        :root {
            --bg-color: #121212;
            --surface-color: #1c1c1c;
            --surface-color-light: #2a2a2a;
            --primary-text: #FFFFFF;
            --secondary-text: #b3b3b3;
            --accent-color: #1DB954;
            --accent-color-dark: #19a34a;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app {
            padding: 1rem 1rem 100px 1rem;
        }
        
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }


        /* 2. Componenti UI Ridisegnati */
        
        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem 0;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--bg-color);
            flex-shrink: 0;
        }
        .page-title {
            font-size: 1.75rem;
            font-weight: 800;
            line-height: 1.2;
        }
        .page-subtitle {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
            text-transform: capitalize;
        }

        /* Titoli di Sezione */
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Card (Per Moduli/Form) */
        .card {
            background: var(--surface-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* Bottoni */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-md);
            border: none;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }
        .btn-primary:hover {
            background-color: var(--accent-color-dark);
        }
        .btn-secondary {
            background-color: var(--surface-color-light);
            color: var(--primary-text);
        }
        .btn.w-full { width: 100%; }

        /* Form */
        .form-group { margin-bottom: 1rem; }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--surface-color-light);
            border: 1px solid var(--surface-color-light);
            border-radius: var(--radius-sm);
            padding: 0.8rem 1rem;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            color: var(--primary-text);
            transition: border-color 0.2s ease;
        }
        .form-input::placeholder { color: var(--secondary-text); }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--secondary-text);
        }
        .form-textarea { resize: vertical; min-height: 100px; }

        /* Stile per pulsante mostra/nascondi password */
        .password-toggle-container {
            position: relative;
        }
        .password-toggle-btn {
            position: absolute;
            right: 0.2rem;
            top: 50%;
            transform: translateY(calc(-50% + 0.75rem)); /* CORREZIONE APPLICATA QUI */
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-text);
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .password-toggle-btn svg {
            width: 22px;
            height: 22px;
        }

        /* --- MODIFICA INIZIO: Stili per selezione proprietà in registrazione --- */
        .property-selection-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: var(--bg-color);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
        }
        .property-selection-item label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-weight: 500;
        }
        .property-selection-item .group-select {
            flex-basis: 160px;
            flex-shrink: 0;
            font-size: 0.9rem;
            padding: 0.6rem 0.8rem;
        }
        /* --- MODIFICA FINE --- */

        /* Messaggi di notifica */
        .message-box {
            padding: 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            margin-bottom: 1.5rem;
            display: none;
        }
        .message-box.success { background-color: rgba(29, 185, 84, 0.2); color: var(--accent-color); }
        .message-box.error { background-color: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            border-top: 1px solid var(--surface-color);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0 1rem 0; /* Aggiunto padding-bottom per schermi con notch */
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .nav-item svg {
            width: 1.75rem;
            height: 1.75rem;
            margin-bottom: 0.25rem;
        }
        .nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        .nav-item.active {
            color: var(--accent-color);
        }
        .notification-badge {
            position: absolute;
            top: 0px;
            right: 15px;
            width: 8px;
            height: 8px;
            background-color: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--bg-color);
        }

        /* Dashboard (Home Page) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .dashboard-item {
            cursor: pointer;
        }
        .dashboard-card {
            background-color: var(--surface-color);
            aspect-ratio: 1 / 1;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .dashboard-item:hover .dashboard-card {
             background-color: var(--surface-color-light);
        }
        .dashboard-card svg {
            width: 40%;
            height: 40%;
            color: var(--primary-text);
        }
        .dashboard-item p {
            font-weight: 600;
            text-align: left;
            padding-left: 0.5rem;
        }

        /* Pagine a Lista */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .list-item:hover {
            background-color: var(--surface-color);
        }
        .list-item-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            background-color: var(--surface-color-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .list-item-icon svg {
            width: 24px;
            height: 24px;
            color: var(--secondary-text);
        }
        .list-item-content {
            flex-grow: 1;
            min-width: 0; /* Fix per flexbox overflow */
        }
        .list-item-content .title {
            font-weight: 600;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-item-content .subtitle {
            font-size: 0.85rem;
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .list-item-action {
            color: var(--accent-color);
            flex-shrink: 0;
        }

        /* Filtri "Chips" */
        .filter-chips-container {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        /* Nasconde la scrollbar */
        .filter-chips-container::-webkit-scrollbar { display: none; }
        .filter-chips-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        .chip {
            padding: 0.5rem 1rem;
            border-radius: 99px;
            background-color: var(--surface-color-light);
            color: var(--primary-text);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .chip.active {
            background-color: var(--primary-text);
            color: var(--bg-color);
        }
        
        /* Badge */
        .badge {
            padding: 0.25rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: capitalize;
            display: inline-block;
        }
        .badge.priority-alta { background-color: #922b21; color: #f5b7b1; }
        .badge.priority-media { background-color: #9c640c; color: #fdebd0; }
        .badge.priority-bassa { background-color: #145a32; color: #a9dfbf; }
        .badge.status-aperta { background-color: #1b4f72; color: #a9cce3; }
        .badge.status-in-corso { background-color: #9c640c; color: #fdebd0; }
        .badge.status-chiusa { background-color: #145a32; color: #a9dfbf; }
        
        /* Poll Bar */
        .poll-option-bar {
            width: 100%;
            background-color: var(--surface-color-light);
            border-radius: 99px;
            height: 6px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .poll-option-fill {
            height: 100%;
            background: var(--secondary-text);
            border-radius: 99px;
            transition: width 0.5s ease;
        }

        /* Stili per il Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            cursor: pointer;
        }
        .modal-content {
            background: var(--surface-color);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            cursor: default;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .modal-close-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-body p {
            line-height: 1.6;
            white-space: pre-wrap; /* Mantiene la formattazione del testo */
        }
        .modal-body .voter-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--surface-color-light);
        }
        .modal-body .voter-item:last-child {
            border-bottom: none;
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .items-center { align-items: center; }
        .justify-end { justify-content: flex-end; }
        .w-full { width: 100%; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .mt-4 { margin-top: 1rem; }
        .user-action-btn {
            background: var(--surface-color-light);
            border: none;
            cursor: pointer;
            color: var(--secondary-text);
            padding: 0.5rem;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: background-color 0.2s, color 0.2s;
        }
        .user-action-btn:hover {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }

        /* Stili per Tabella Dati */
        .data-table-container {
            overflow-x: auto; /* Per responsività su schermi piccoli */
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--surface-color-light);
            white-space: nowrap;
        }
        .data-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
        }
        .data-table td {
            font-size: 0.95rem;
        }
        .data-table tr:hover {
            background-color: var(--surface-color-light);
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* --- Stili per Custom Searchable Dropdown --- */
        .custom-dropdown-container {
            position: relative;
        }
        .custom-dropdown-list {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background-color: var(--surface-color-light);
            border: 1px solid var(--surface-color);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1100; /* Sopra altri elementi del form */
        }
        .custom-dropdown-list::-webkit-scrollbar { display: none; }
        .custom-dropdown-list { -ms-overflow-style: none; scrollbar-width: none; }

        .custom-dropdown-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            color: var(--primary-text);
            transition: background-color 0.2s ease;
        }
        .custom-dropdown-item:hover, .custom-dropdown-item.highlighted {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }
        .custom-dropdown-item:not(:last-child) {
            border-bottom: 1px solid var(--surface-color);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app"></div>

    <div id="modal-container" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title"></h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, where, getDocs, deleteDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrLAomryfk-0s5Inm2XOsBrJusgmMI87E",
            authDomain: "condo-app-49255.firebaseapp.com",
            projectId: "condo-app-49255",
            storageBucket: "condo-app-49255.appspot.com",
            messagingSenderId: "485319278595",
            appId: "1:485319278595:web:2997689b234fbba4dece36",
            measurementId: "G-2SM3DH41EZ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userProfile = null;
        let currentPage = 'login';
        let communicationsListener = null;
        let navigationHistory = [];

        // Stato per la registrazione, reso globale a livello di modulo per un reset corretto
        let groupedProperties = {};
        let partialCondosList = [];

        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
        const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-4 .68l1.64 1.64C9.74 7.13 10.82 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L21.73 23 20.46 21.73 4.54 5.81 3.27 4.54 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;

        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const showModal = (title, contentHtml) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHtml;
            modalContainer.classList.remove('hidden');
        };

        const hideModal = () => {
            modalContainer.classList.add('hidden');
        };

        modalCloseBtn.addEventListener('click', hideModal);
        modalContainer.addEventListener('click', (event) => {
            if (event.target === modalContainer) {
                hideModal();
            }
        });
        
        const logActivity=async(t,e,o,a={})=>{try{await addDoc(collection(db,"activities"),{type:t,userId:e,userName:o,details:a,timestamp:serverTimestamp(),createdAt:new Date})}catch(n){console.error("Errore nel logging:",n)}};
        const register=async(t,e,o)=>{const a=await createUserWithEmailAndPassword(auth,t,e);const totalMillesimi=o.proprieta.reduce(((sum,prop)=>sum+(parseFloat(prop.millesimi)||0)),0);return await setDoc(doc(db,"users",a.user.uid),{nome:o.nome,cognome:o.cognome,email:t,tipoUtente:o.tipoUtente,proprieta:o.proprieta||[],telefono:o.telefono||"",millesimiTotali:totalMillesimi,createdAt:(new Date).toISOString()}),await logActivity("user_registered",a.user.uid,`${o.nome} ${o.cognome}`,{userType:o.tipoUtente}),a};
        const login=async(t,e)=>await signInWithEmailAndPassword(auth,t,e);
        
        // --- FUNZIONE LOGOUT CORRETTA ---
        const logout=async()=>{
            communicationsListener&&(communicationsListener(),communicationsListener=null);
            // Si limita a chiamare signOut. Sarà onAuthStateChanged a gestire il resto.
            await signOut(auth);
        };

        const resetPassword=async t=>await sendPasswordResetEmail(auth,t);
        const loadUserProfile=async t=>{if(t){const e=await getDoc(doc(db,"users",t.uid));e.exists()&&(userProfile=e.data())}};
        
        const navigateTo=(e)=>{
            const userType = userProfile?.tipoUtente;

            if (navigationHistory[navigationHistory.length - 1] !== e) {
                navigationHistory.push(e);
            }

            if (['supervisore', 'adm'].includes(userType) && ['userManagement', 'gestioneGruppi', 'importazione'].includes(e)) {
                 currentPage = e;
                 renderCurrentPage();
                 return;
            }
            if(userType==="custode"&&["dashboard","bacheca","sondaggi"].includes(e)){
                navigateTo("segnalazioni");
            } else {
                currentPage=e,renderCurrentPage();
            }
        };

        const navigateBack = () => {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Rimuove la pagina corrente dalla cronologia
                currentPage = navigationHistory[navigationHistory.length - 1]; // La pagina precedente diventa quella corrente
                renderCurrentPage();
            }
            // Non fa nulla se non c'è una pagina precedente
        };
        
        const getPriorityColor=t=>({alta:"priority-alta",media:"priority-media",bassa:"priority-bassa"}[t]||"priority-bassa");
        const getStatusColor=t=>({aperta:"status-aperta","in-corso":"status-in-corso",chiusa:"status-chiusa"}[t]||"status-aperta");
        
        const renderHeader = (title) => {
            const userInitial = userProfile?.nome ? userProfile.nome.charAt(0).toUpperCase() : 'U';
            const userType = userProfile?.tipoUtente || '';

            const backButtonHtml = navigationHistory.length > 1 ? `
                <button onclick="navigateBack()" style="background:none; border:none; color:var(--primary-text); cursor:pointer; padding:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
            ` : '';

            return `
            <header class="page-header">
                ${backButtonHtml}
                <div class="user-avatar">${userInitial}</div>
                <div>
                    <h1 class="page-title">${title}</h1>
                    <p class="page-subtitle">${userType}</p>
                </div>
            </header>`;
        }

        const renderLoginPage = () => `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:1rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--accent-color);">Con-bridge</h1>
                <h2 id="auth-title" style="font-size: 1.5rem; font-weight: 600; margin-bottom: 2rem;">Accedi</h2>
                
                <div id="error-message" class="message-box error w-full" style="max-width:400px;"></div>
                <div id="success-message" class="message-box success w-full" style="max-width:400px;"></div>

                <form id="auth-form" class="space-y-4 w-full" style="max-width:400px;">
                    <div class="form-group"><label for="email" class="form-label">Email</label><input id="email" name="email" type="email" required placeholder="la-tua-email@esempio.com" class="form-input"></div>
                    
                    <div class="form-group password-toggle-container">
                        <label for="password" class="form-label">Password</label>
                        <input id="password" name="password" type="password" required placeholder="••••••••" class="form-input" style="padding-right: 3.5rem;">
                        <button type="button" class="password-toggle-btn" data-target="password">${eyeIcon}</button>
                    </div>
                    
                    <div id="register-fields" class="hidden space-y-4">
                        <div class="form-group password-toggle-container">
                            <label for="confirm-password" class="form-label">Conferma Password</label>
                            <input id="confirm-password" name="confirm-password" type="password" placeholder="••••••••" class="form-input" style="padding-right: 3.5rem;">
                            <button type="button" class="password-toggle-btn" data-target="confirm-password">${eyeIcon}</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="nome" class="form-label">Nome</label><input id="nome" name="nome" type="text" placeholder="Mario" class="form-input"></div>
                            <div class="form-group"><label for="cognome" class="form-label">Cognome</label><input id="cognome" name="cognome" type="text" placeholder="Rossi" class="form-input"></div>
                        </div>
                        <input id="tipo-utente" name="tipo-utente" type="hidden" value="condomino">
                        <p style="font-size: 0.8rem; color: var(--secondary-text); text-align: center; margin-top: -0.5rem; margin-bottom: 1rem;">La registrazione è consentita solo ai condomini. Per altri ruoli, contattare il supervisore.</p>
                        
                        <div class="form-group custom-dropdown-container">
                            <label for="nominativo-search" class="form-label">Nominativo proprietario</label>
                            <input id="nominativo-search" name="nominativo-search" type="text" placeholder="Digita per cercare e selezionare..." class="form-input" autocomplete="off">
                            <div id="nominativo-options" class="custom-dropdown-list hidden">
                                <!-- Le opzioni verranno popolate dinamicamente via JS -->
                            </div>
                        </div>

                        <!-- --- MODIFICA INIZIO: Contenitore per la selezione delle proprietà e dei gruppi --- -->
                        <div id="property-selection-wrapper" class="form-group hidden" style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm);">
                             <label class="form-label" style="margin-bottom: 1rem;">Seleziona le tue Unità e assegna un Gruppo</label>
                             <div id="property-items-container" class="space-y-4">
                                 <!-- Le proprietà con i dropdown verranno aggiunte dinamicamente qui -->
                             </div>
                        </div>
                        <!-- --- MODIFICA FINE --- -->

                        <div class="form-group">
                            <label class="form-label">Riepilogo Selezione</label>
                            <div id="selection-summary" style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm); min-height: 60px; color: var(--secondary-text);">
                                Seleziona un nominativo per continuare...
                            </div>
                        </div>
                        <div class="form-group"><label for="telefono" class="form-label">Telefono</label><input id="telefono" name="telefono" type="tel" placeholder="123-456-7890" class="form-input"></div>
                    </div>
                    
                    <button type="submit" id="auth-submit" class="btn btn-primary w-full">Accedi</button>

                    <div id="error-message" class="message-box error w-full" style="max-width:400px; margin-top: 1rem;"></div>
                    <div id="success-message" class="message-box success w-full" style="max-width:400px; margin-top: 1rem;"></div>
                </form>

                <div class="flex w-full mt-4" style="max-width:400px; justify-content: space-between;">
                    <button type="button" id="toggle-auth" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Registrati</button>
                    <button type="button" id="forgot-password" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Password dimenticata?</button>
                </div>

                <div id="error-message" class="message-box error w-full" style="max-width:400px; margin-top: 1rem;"></div>
                <div id="success-message" class="message-box success w-full" style="max-width:400px; margin-top: 1rem;"></div>
            </div>`;

        const renderBottomNavigation = () => {
            const isCustodian = userProfile?.tipoUtente === 'custode';

            const navItems = isCustodian
                ? `
                    <a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${currentPage === 'segnalazioni' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg>
                        <span>Segnala</span>
                    </a>
                    <a href="#" onclick="navigateTo('infoUtili')" class="nav-item ${currentPage === 'infoUtili' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z" /></svg>
                        <span>Orari</span>
                    </a>
                    <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
                        <span>Profilo</span>
                    </a>
                `
                : `
                    <a href="#" onclick="navigateTo('dashboard')" class="nav-item ${currentPage === 'dashboard' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></a>
                    <a href="#" onclick="navigateTo('bacheca')" id="nav-item-bacheca" class="nav-item ${currentPage === 'bacheca' ? 'active' : ''}"><span id="bacheca-notification-badge" class="notification-badge hidden"></span><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg><span>Bacheca</span></a>
                    <a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${currentPage === 'segnalazioni' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg><span>Segnala</span></a>
                    <a href="#" onclick="navigateTo('sondaggi')" class="nav-item ${['sondaggi', 'sondaggi_crea', 'sondaggi_elenco'].includes(currentPage) ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg><span>Sondaggi</span></a>
                    <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg><span>Profilo</span></a>
                `;
            return `<nav class="bottom-nav">${navItems}</nav>`;
        };
        
        const renderDashboard = () => {
            let extraItems = '';
                        if (['supervisore', 'adm'].includes(userProfile?.tipoUtente)) {
                extraItems = `
                    <div onclick="navigateTo('gestioneGruppi')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                            </svg>
                        </div>
                        <p>Funzioni Supervisor</p>
                    </div>
                `;
            }
            return `
            ${renderHeader('Home')}
            <main>
                                <h2 class="section-title">Accesso Rapido</h2>
                <div class="dashboard-grid">
                    <div onclick="navigateTo('bacheca')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <p>Bacheca</p>
                    </div>
                    <div onclick="navigateTo('segnalazioni')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
                        <p>Segnalazioni</p>
                    </div>
                    <div onclick="navigateTo('sondaggi')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                        <p>Sondaggi</p>
                    </div>
                    <div onclick="navigateTo('infoUtili')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></div>
                        <p>Numeri utili</p>
                    </div>
                    <div onclick="navigateTo('reportPage')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 17H4v2h10v-2m6-8H4v2h16V9m-4 4H4v2h12v-2M22 4H2v16h20V4z"/></svg></div>
                        <p>Report</p>
                    </div>
                    ${extraItems}
                </div>
                
                <div style="margin-top: 2rem;">
                  <button onclick="logout()" class="btn btn-secondary w-full">Esci</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;}

        const renderBacheca = () => `
            ${renderHeader('Bacheca')}
            <main>
                ${(userProfile?.tipoUtente === 'amministratore' || userProfile?.tipoUtente === 'supervisore') ? `<div class="card" style="margin-bottom:2rem;"><h3 class="card-title">Nuova comunicazione</h3><form id="create-communication-form" class="space-y-4"><div><label for="comm-title" class="form-label">Titolo</label><input type="text" id="comm-title" required class="form-input" placeholder="Es. Interruzione acqua"></div><div><label for="comm-content" class="form-label">Messaggio</label><textarea id="comm-content" rows="4" required class="form-textarea" placeholder="Scrivi qui..."></textarea></div><div class="flex justify-end"><button type="submit" id="publish-comm-btn" class="btn btn-primary">Pubblica</button></div></form></div>` : ''}
                <div id="communications-list" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggiMenu = () => `
            ${renderHeader('Sondaggi')}
            <main>
                <div class="dashboard-grid">
                    <div onclick="navigateTo('sondaggi_crea')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        </div>
                        <p>Crea Nuovo Sondaggio</p>
                    </div>
                    <div onclick="navigateTo('sondaggi_elenco')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg>
                        </div>
                        <p>Elenco Sondaggi</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggiCrea = () => `
            ${renderHeader('Crea Sondaggio')}
            <main>
                <div class="card">
                    <h3 class="card-title">Crea un Nuovo Sondaggio</h3>
                    <div id="poll-creation-message" class="message-box"></div>
                    <form id="create-poll-form" class="space-y-4">
                        <div><label class="form-label">Titolo</label><input type="text" id="poll-title" required class="form-input"></div>
                        <div><label class="form-label">Descrizione (opzionale)</label><textarea id="poll-description" rows="3" class="form-textarea"></textarea></div>
                        <div><label class="form-label">Opzioni</label><div id="poll-options-list" class="space-y-4"></div><button type="button" id="add-poll-option" class="btn btn-secondary mt-4">Aggiungi opzione</button></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Data fine</label><input type="date" id="poll-deadline" required class="form-input"></div>
                            <div><label class="form-label">Ora fine</label><input type="time" id="poll-deadline-time" required class="form-input"></div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="flex items-center gap-3 p-3 rounded-md cursor-pointer" style="background-color: var(--surface-color-light);">
                                <input type="checkbox" id="poll-multiple-choice" style="width: 20px; height: 20px; accent-color: var(--accent-color); flex-shrink: 0;">
                                <span class="font-medium">Abilita Risposta Multipla</span>
                            </label>
                        </div>
                        <div class="flex justify-end gap-4 pt-4"><button type="reset" class="btn btn-secondary">Annulla</button><button type="submit" class="btn btn-primary">Crea</button></div>
                    </form>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggiElenco = () => `
            ${renderHeader('Elenco Sondaggi')}
            <main>
                <div id="polls-container" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSegnalazioni = () => {
             const isCustodian = userProfile?.tipoUtente === 'custode';
             const formRecipientField = isCustodian ? `<div><label class="form-label">Destinatario</label><select id="report-recipient" required class="form-select"><option value="">Seleziona...</option><option value="amministratore">Amministratore</option><option value="consigliere">Consiglieri</option><option value="condomino">Tutti i Condomini</option></select></div>` : '';
             return `
                ${renderHeader('Segnalazioni')}
                <main>
                    <div class="card" style="margin-bottom:2rem;">
                        <h3 class="card-title">Invia una Segnalazione</h3>
                        <form id="create-report-form" class="space-y-4">
                            <div><label class="form-label">Titolo</label><input type="text" id="report-title" required class="form-input" placeholder="es. Perdita d'acqua"></div>
                            <div><label class="form-label">Descrizione</label><textarea id="report-description" rows="4" required class="form-textarea" placeholder="Descrivi il problema..."></textarea></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-label">Categoria</label><select id="report-category" required class="form-select"><option value="">...</option><option value="idraulico">Idraulico</option><option value="elettrico">Elettrico</option><option value="riscaldamento">Riscaldamento</option><option value="ascensore">Ascensore</option><option value="pulizie">Pulizie</option><option value="sicurezza">Sicurezza</option><option value="altro">Altro</option></select></div>
                                <div><label class="form-label">Priorità</label><select id="report-priority" required class="form-select"><option value="">...</option><option value="bassa">Bassa</option><option value="media">Media</option><option value="alta">Alta</option></select></div>
                            </div>
                            <div><label class="form-label">Ubicazione</label><input type="text" id="report-location" required class="form-input" placeholder="es. Scala A, Piano 2"></div>
                            ${formRecipientField}
                            <div class="flex justify-end pt-4"><button type="submit" class="btn btn-primary">Invia Segnalazione</button></div>
                        </form>
                    </div>
                    <div class="mt-4"><h2 class="section-title">Segnalazioni Ricevute</h2><div id="reports-main-container" class="list-container"></div></div>
                    <div class="mt-4"><h2 class="section-title">Le Tue Segnalazioni</h2><div id="reports-secondary-container" class="list-container"></div></div>
                </main>
                ${renderBottomNavigation()}
             `;
        };

        const renderProfilo = () => `
            ${renderHeader('Profilo')}
            <main>
                <div id="profile-message" class="message-box"></div>
                <div class="card">
                    <h3 class="card-title">I Tuoi Dati</h3>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Nome</label><input type="text" id="profile-nome" value="${userProfile?.nome || ''}" required class="form-input"></div>
                            <div><label class="form-label">Cognome</label><input type="text" id="profile-cognome" value="${userProfile?.cognome || ''}" required class="form-input"></div>
                        </div>
                        <div><label class="form-label">Email</label><input type="email" value="${currentUser?.email || ''}" required class="form-input" disabled></div>
                        <div><label class="form-label">Telefono</label><input type="tel" id="profile-telefono" value="${userProfile?.telefono || ''}" placeholder="Nessun numero" class="form-input"></div>
                        <div class="form-group">
                            <label class="form-label">Le Tue Proprietà</label>
                            <div style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm);">
                                ${userProfile?.proprieta && userProfile.proprieta.length > 0
                                    ? `<ul>${userProfile.proprieta.map(p => `<li style="list-style-type: disc; margin-left: 20px;">${p.interno} (${(p.millesimi || 0).toFixed(2)} ‰) ${p.gruppo ? `- <strong>Gruppo:</strong> ${p.gruppo}` : ''}</li>`).join('')}</ul>
                                       <hr style="border-color: var(--surface-color); margin: 0.75rem 0;">
                                       <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Millesimi Totali:</span><span>${(userProfile.millesimiTotali || 0).toFixed(2)} ‰</span></div>`
                                    : '<p style="color:var(--secondary-text);">Nessuna proprietà associata.</p>'
                                }
                            </div>
                        </div>
                        <div><label class="form-label">Tipo Utente</label><input type="text" value="${userProfile?.tipoUtente || ''}" class="form-input" disabled></div>
                        <button type="submit" class="btn btn-primary w-full">Salva Nome e Telefono</button>
                    </form>
                </div>
                 <div style="margin-top: 2rem;">
                  <button onclick="logout()" class="btn btn-secondary w-full">Esci</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        
                const renderInfoUtili = () => `
            ${renderHeader('Numeri Utili')}
            <main>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <div onclick="navigateTo('numeriUtiliImportati')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg></div>
                        <p>Importazione</p>
                    </div>
                    <div onclick="navigateTo('numeriUtiliManuali')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"/></svg></div>
                        <p>Inserimento</p>
                    </div>
                    <div onclick="navigateTo('numeriUtiliRubrica')" class="dashboard-item" style="grid-column: 1 / -1;">
                        <div class="dashboard-card" style="aspect-ratio: auto; height: 80px; flex-direction: row; justify-content: flex-start; gap: 1.5rem; padding: 1rem 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M20,2H4A2,2 0 0,0 2,4V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V4A2,2 0 0,0 20,2M12,6A3,3 0 0,1 15,9A3,3 0 0,1 12,12A3,3 0 0,1 9,9A3,3 0 0,1 12,6M18,20H6V18.6C6,16.6 10,15.5 12,15.5C14,15.5 18,16.6 18,18.6V20Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Rubrica Completa</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderNumeriUtiliImportati = () => {
            const canManage = ['amministratore', 'supervisore', 'adm'].includes(userProfile?.tipoUtente);
            const importSectionHtml = canManage ? `
                <div class="flex gap-4 mt-4">
                    <button id="trigger-phone-import-btn" class="btn btn-primary flex-grow">Importa Nuovo File</button>
                    <button onclick="navigateTo('importazione')" class="btn btn-secondary">Gestione Avanzata</button>
                </div>
                <input type="file" id="info-utili-phone-import-input" class="hidden" accept=".xlsx, .xls">
                <div id="info-utili-import-message" class="message-box mt-4"></div>
            ` : '';

            return `
            ${renderHeader('Contatti Importati')}
            <main>
                <div class="card">
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 1.5rem;">
                        Elenco dei contatti importati tramite file Excel. Il file più recente sostituisce i precedenti.
                    </p>
                    <div id="imported-numbers-table-container" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento contatti importati...</p>
                    </div>
                    ${importSectionHtml}
                </div>
            </main>
            ${renderBottomNavigation()}
            `;
        };

        const renderNumeriUtiliManuali = () => {
            const canManage = ['amministratore', 'supervisore', 'adm'].includes(userProfile?.tipoUtente);
            const addFormHtml = canManage ? `
                <form id="add-useful-number-form" class="space-y-4" style="margin-bottom: 2rem;">
                    <div><label for="nu-title" class="form-label">Intervento richiesto</label><input type="text" id="nu-title" required class="form-input" placeholder="Es. Idraulico, Elettricista..."></div>
                    <div><label for="nu-company" class="form-label">Impresa (Opzionale)</label><input type="text" id="nu-company" class="form-input" placeholder="Nome dell'azienda"></div>
                    <div><label for="nu-number" class="form-label">1 num. Telefonico</label><input type="text" id="nu-number" required class="form-input" placeholder="Numero di telefono principale"></div>
                    <div><label for="nu-number-2" class="form-label">2 num. Telefonico (Opzionale)</label><input type="text" id="nu-number-2" class="form-input" placeholder="Numero di telefono secondario"></div>
                    <div class="flex justify-end"><button type="submit" class="btn btn-primary">Aggiungi Contatto</button></div>
                </form>
            ` : '';

            return `
            ${renderHeader('Contatti Manuali')}
            <main>
                <div class="card">
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 1.5rem;">Aggiungi o visualizza i contatti di emergenza inseriti manualmente. La modifica è riservata ai ruoli autorizzati.</p>
                    ${addFormHtml}
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Intervento richiesto</th>
                                    <th>Impresa</th>
                                    <th>1 num.Telefonico</th>
                                    <th>2 num.Telefonico</th>
                                    <th style="text-align:right;">Azione</th>
                                </tr>
                            </thead>
                            <tbody id="useful-numbers-table-body">
                                <tr><td colspan="5" style="text-align:center; color:var(--secondary-text);">Caricamento contatti...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
            `;
        };

        const renderReportPage = () => `
            ${renderHeader('Report')}
            <main>
                <div class="dashboard-grid">
                    <div onclick="navigateTo('elencoCondomini')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7v13h20V7L12 2z"/></svg></div>
                        <p>Elenco Condomini</p>
                    </div>
                    <div onclick="navigateTo('bacheca')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <p>Bacheca</p>
                    </div>
                    <div onclick="navigateTo('sondaggi')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                        <p>Sondaggi</p>
                    </div>
                    <div onclick="navigateTo('infoUtili')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></div>
                        <p>Numeri utili</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderElencoCondomini = () => `
            ${renderHeader('Elenco Condomini')}
            <main>
                <div class="filter-chips-container" style="margin-bottom: 1.5rem;">
                    <div id="report-mode-confronto" class="chip active" onclick="loadElencoCondomini('confronto')">Confronto Dati</div>
                    <div id="report-mode-complessiva" class="chip" onclick="loadElencoCondomini('complessiva')">Riepilogo Complessivo</div>
                    <div id="report-mode-anagrafica" class="chip" onclick="loadElencoCondomini('anagrafica')">Riepilogo Anagrafica</div>
                </div>
                <div id="elenco-condomini-container">
                    <div class="card"><p>Caricamento elenco in corso...</p></div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const loadElencoCondomini = async (mode = 'confronto') => {
            // --- 1. Aggiornamento UI per la selezione della modalità ---
            const confrontoBtn = document.getElementById('report-mode-confronto');
            const complessivaBtn = document.getElementById('report-mode-complessiva');
            const anagraficaBtn = document.getElementById('report-mode-anagrafica');
            if (confrontoBtn && complessivaBtn && anagraficaBtn) {
                confrontoBtn.classList.toggle('active', mode === 'confronto');
                complessivaBtn.classList.toggle('active', mode === 'complessiva');
                anagraficaBtn.classList.toggle('active', mode === 'anagrafica');
            }

            const container = document.getElementById('elenco-condomini-container');
            if (!container) return;
            container.innerHTML = `<div class="card"><p>Caricamento dati in modalità '${mode}'...</p></div>`;

            try {
                // --- 2. Recupero Dati ---
                const [usersSnapshot, importedDataSnapshot, partialCondosSnapshot] = await Promise.all([
                    getDocs(query(collection(db, "users"), orderBy("cognome"))),
                    getDocs(query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1))),
                    getDocs(query(collection(db, "partialCondos"), orderBy("name")))
                ]);

                if (mode !== 'anagrafica' && importedDataSnapshot.empty) {
                    container.innerHTML = `<div class="card"><p class="message-box error" style="display:block;">Dati delle proprietà non trovati. Eseguire prima l'importazione.</p></div>`;
                    return;
                }

                // --- 3. Preparazione Dati ---
                const allProperties = !importedDataSnapshot.empty ? importedDataSnapshot.docs[0].data().tableData : [];
                const partialCondosList = partialCondosSnapshot.docs.map(doc => doc.data());
                const headers = Object.keys(allProperties[0] || {});
                const findHeader = (h, k) => h.find(header => k.map(key => key.toLowerCase()).includes(header.toLowerCase()));
                const millesimiHeader = findHeader(headers, ['millesimi', 'quota']);
                const groupHeader = findHeader(headers, ['raggruppamento', 'gruppo']);

                // --- 4. Logica di Raggruppamento e Generazione HTML ---
                let html = '';

                if (mode === 'anagrafica') {
                    html = `<h2 class="section-title">Riepilogo Anagrafica Utenti Registrati</h2>`;
                    if (usersSnapshot.empty) {
                        html += `<div class="card"><p>Nessun utente registrato.</p></div>`;
                    } else {
                        html += `<div class="card" style="padding:0;"><div class="data-table-container"><table class="data-table">
                                    <thead><tr><th>Cognome e Nome</th><th>Email</th><th>Proprietà</th><th style="text-align:right;">Millesimi Tot.</th></tr></thead>
                                    <tbody>`;
                        usersSnapshot.docs.forEach(doc => {
                            const user = doc.data();
                            const propertiesHtml = user.proprieta && user.proprieta.length > 0
                                ? user.proprieta.map(p => `<div>${p.interno} (${(p.millesimi || 0).toFixed(2)} ‰)</div>`).join('')
                                : 'N/D';
                            html += `
                                <tr>
                                    <td>${user.cognome} ${user.nome}</td>
                                    <td>${user.email}</td>
                                    <td>${propertiesHtml}</td>
                                    <td style="text-align:right;">${(user.millesimiTotali || 0).toFixed(2).replace('.', ',')}</td>
                                </tr>
                            `;
                        });
                        html += `</tbody></table></div></div>`;
                    }
                } else {
                    const groupedData = {};
                    partialCondosList.forEach(condo => {
                        groupedData[condo.name] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                    });
                    if (!groupedData['Senza Gruppo']) {
                        groupedData['Senza Gruppo'] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                    }

                    usersSnapshot.docs.forEach(doc => {
                        const user = doc.data();
                        user.proprieta?.forEach(prop => {
                            const groupName = prop.gruppo || 'Senza Gruppo';
                            if (!groupedData[groupName]) {
                                groupedData[groupName] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                            }
                            groupedData[groupName].users.push({
                                idUI: prop.interno,
                                proprietario: `${user.nome} ${user.cognome}`,
                                millesimi: parseFloat(prop.millesimi) || 0
                            });
                        });
                    });

                    allProperties.forEach(prop => {
                        const groupName = (groupHeader && prop[groupHeader]) ? prop[groupHeader] : 'Senza Gruppo';
                        if (!groupedData[groupName]) {
                            groupedData[groupName] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                        }
                        groupedData[groupName].totalMillesimiImport += parseFloat(prop[millesimiHeader]) || 0;
                        groupedData[groupName].totalPropertiesImport += 1;
                    });

                    const grandTotalAllMillesimi = Object.values(groupedData).reduce((sum, group) => sum + group.totalMillesimiImport, 0);
                    const grandTotalProperties = Object.values(groupedData).reduce((sum, group) => sum + group.totalPropertiesImport, 0);

                    if (mode === 'confronto') {
                        html = `<h2 class="section-title">Confronto Dati Registrati vs. Importati</h2>`;
                        let grandTotalAccounts = 0;
                        let grandTotalAccountMillesimi = 0;

                        for (const groupName in groupedData) {
                            const group = groupedData[groupName];
                            if (group.users.length === 0 && group.totalPropertiesImport === 0) continue;
                            const accountSubtotalMillesimi = group.users.reduce((sum, u) => sum + u.millesimi, 0);
                            grandTotalAccounts += group.users.length;
                            grandTotalAccountMillesimi += accountSubtotalMillesimi;
                            html += `<div class="card" style="margin-bottom: 1.5rem;"><h3 class="card-title" style="text-transform: capitalize;">${groupName.toLowerCase()}</h3><div class="data-table-container"><table class="data-table"><thead><tr><th>Id U.I.</th><th>Proprietario Registrato</th><th style="text-align:right;">Millesimi</th></tr></thead><tbody>${group.users.length > 0 ? group.users.map(u => `<tr><td>${u.idUI}</td><td>${u.proprietario}</td><td style="text-align:right;">${u.millesimi.toFixed(2).replace('.', ',')}</td></tr>`).join('') : `<tr><td colspan="3" style="color:var(--secondary-text); text-align:center;">Nessun account registrato per questo gruppo.</td></tr>`}<tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Account Registrati</td><td style="text-align:right;">${group.users.length}</td><td style="text-align:right;">${accountSubtotalMillesimi.toFixed(2).replace('.', ',')}</td></tr><tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Unità da Import</td><td style="text-align:right;">${group.totalPropertiesImport}</td><td style="text-align:right;">${group.totalMillesimiImport.toFixed(2).replace('.', ',')}</td></tr></tbody></table></div></div>`;
                        }
                        html += `<div class="card" style="margin-bottom: 1.5rem;"><h3 class="card-title">Riepilogo Complessivo Confronto</h3><div class="data-table-container"><table class="data-table"><tbody><tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Account Registrati</td><td style="text-align:right;">${grandTotalAccounts}</td><td style="text-align:right;">${grandTotalAccountMillesimi.toFixed(2).replace('.', ',')}</td></tr><tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Unità da Import</td><td style="text-align:right;">${grandTotalProperties}</td><td style="text-align:right;">${grandTotalAllMillesimi.toFixed(2).replace('.', ',')}</td></tr></tbody></table></div></div>`;
                    } else { // mode === 'complessiva'
                        html = `<h2 class="section-title">Riepilogo Complessivo Dati Importati</h2><div class="card" style="margin-bottom: 1.5rem;"><div class="data-table-container"><table class="data-table"><thead><tr><th>Gruppo / Scala</th><th style="text-align:right;">N. Unità (Teste)</th><th style="text-align:right;">Somma Millesimi</th></tr></thead><tbody>`;
                        for (const groupName in groupedData) {
                            const group = groupedData[groupName];
                            if (group.totalPropertiesImport === 0) continue;
                            html += `<tr><td style="text-transform: capitalize;">${groupName.toLowerCase()}</td><td style="text-align:right;">${group.totalPropertiesImport}</td><td style="text-align:right;">${group.totalMillesimiImport.toFixed(2).replace('.', ',')}</td></tr>`;
                        }
                        html += `<tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Complessivo</td><td style="text-align:right;">${grandTotalProperties}</td><td style="text-align:right;">${grandTotalAllMillesimi.toFixed(2).replace('.', ',')}</td></tr></tbody></table></div></div>`;
                    }
                }

                container.innerHTML = html;

            } catch (error) {
                console.error("Errore nel caricamento dell'elenco condomini:", error);
                container.innerHTML = `<div class="card"><p class="message-box error" style="display:block;">Si è verificato un errore: ${error.message}</p></div>`;
            }
        };

                const renderImportazione = () => `
            ${renderHeader('Importazione Dati')}
            <main>
                <!-- SEZIONE 1: IMPORTAZIONE MILLESIMI / ANAGRAFICA -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="card-title">Importa Anagrafica e Millesimi</h3>
                    <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Carica il file Excel contenente i dati anagrafici dei proprietari, le unità immobiliari e i relativi millesimi. Questo file è <strong>fondamentale</strong> per la registrazione degli utenti e per i report.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Carica Nuovo File Anagrafica (.xlsx, .xls)</label>
                        <input type="file" id="excel-file-input-millesimi" class="form-input" accept=".xlsx, .xls">
                    </div>
                    <div id="message-import-millesimi" class="message-box"></div>
                    <div id="save-button-container-millesimi" class="hidden mt-4">
                        <button id="save-imported-data-btn-millesimi" class="btn btn-primary w-full">Salva Dati Anagrafica</button>
                    </div>
                    <div class="mt-4">
                        <h4 class="section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Anteprima / Dati Attuali</h4>
                        <div id="excel-table-container-millesimi" class="data-table-container">
                            <p style="color:var(--secondary-text);">Nessun file selezionato o caricato.</p>
                        </div>
                    </div>
                </div>

                <!-- SEZIONE 2: IMPORTAZIONE NUMERI DI TELEFONO -->
                <div class="card">
                    <h3 class="card-title">Importa Numeri di Telefono Utili</h3>
                    <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Carica un file Excel separato per i numeri di telefono utili (es. fornitori, emergenze). Questi dati verranno visualizzati nella pagina "Numeri Utili".
                    </p>
                    <div class="form-group">
                        <label class="form-label">Carica Nuovo File Numeri (.xlsx, .xls)</label>
                        <input type="file" id="excel-file-input-phones" class="form-input" accept=".xlsx, .xls">
                    </div>
                    <div id="message-import-phones" class="message-box"></div>
                    <div id="save-button-container-phones" class="hidden mt-4">
                        <button id="save-imported-data-btn-phones" class="btn btn-primary w-full">Salva Numeri Utili</button>
                    </div>
                    <div class="mt-4">
                        <h4 class="section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Anteprima / Dati Attuali</h4>
                        <div id="excel-table-container-phones" class="data-table-container">
                            <p style="color:var(--secondary-text);">Nessun file selezionato o caricato.</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        
                const renderGestioneGruppiMenu = () => `
            ${renderHeader('Funzioni Supervisor')}
            <main>
                <div class="dashboard-grid" style="grid-template-columns: 1fr;">
                    <div onclick="navigateTo('userManagement')" class="dashboard-item">
                        <div class="dashboard-card" style="aspect-ratio: auto; padding: 1.5rem; flex-direction: row; justify-content: flex-start; gap: 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Gestione Utenti</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('gestioneGruppi_lista')" class="dashboard-item">
                        <div class="dashboard-card" style="aspect-ratio: auto; padding: 1.5rem; flex-direction: row; justify-content: flex-start; gap: 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M10 4v4h4V4h-4m6 12v4h4v-4h-4m-6 0v4h4v-4h-4m6-6v4h4v-4h-4m-6 0v4h4v-4h-4m-6-6v4h4V4H4m6 6v4h4v-4h-4M4 16v4h4v-4H4m14-2h2v-4h-2v4m0 6h2v-4h-2v4m-12-2h2v-4H6v4m0 6h2v-4H6v4M2 2v20h20V2H2z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Crea e Visualizza Gruppi</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('gestioneGruppi_regole')" class="dashboard-item">
                        <div class="dashboard-card" style="aspect-ratio: auto; padding: 1.5rem; flex-direction: row; justify-content: flex-start; gap: 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Gestione Regole</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('importazione')" class="dashboard-item">
                        <div class="dashboard-card" style="aspect-ratio: auto; padding: 1.5rem; flex-direction: row; justify-content: flex-start; gap: 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Importa Dati</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('impostazioniSondaggi')" class="dashboard-item">
                        <div class="dashboard-card" style="aspect-ratio: auto; padding: 1.5rem; flex-direction: row; justify-content: flex-start; gap: 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M3,5H9V11H3V5M5,7V9H7V7H5M11,7H21V9H11V7M11,15H21V17H11V15M5,15H7V17H5V15M3,13H9V19H3V13Z" /></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Gestione Sondaggi</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderGestioneGruppi_Lista = () => `
            ${renderHeader('Crea e Visualizza Gruppi')}
            <main>
                <div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Crea Gruppo Manualmente</h3>
                    <form id="create-partial-condo-form" class="flex gap-4">
                        <div class="form-group" style="flex-grow:1; margin-bottom:0;">
                            <input type="text" id="partial-condo-name" required class="form-input" placeholder="Es. Scala Bellini 11, Box, Giardino...">
                        </div>
                        <button type="submit" class="btn btn-primary">Crea Gruppo</button>
                    </form>
                </div>

                <div class="card" style="margin-bottom: 2.5rem;">
                    <div 
                        id="toggle-group-list-btn" 
                        onclick="toggleGroupListVisibility()" 
                        class="flex items-center justify-between" 
                        style="cursor: pointer; padding-bottom: 1rem; border-bottom: 1px solid var(--surface-color-light);"
                    >
                        <h3 class="card-title" style="margin-bottom: 0;">Elenco Gruppi Creati</h3>
                        <svg id="group-list-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px; transition: transform 0.3s ease;">
                            <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                        </svg>
                    </div>
                    <div id="partial-condos-list" class="list-container" style="padding-top: 1rem;">
                        <p>Caricamento...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderGestioneGruppi_Regole = () => `
            ${renderHeader('Gestione Regole')}
            <main>
                <div class="flex items-center justify-between" style="margin-bottom: 1rem;">
                    <h2 class="section-title" style="margin-bottom: 0;">Regole di Classificazione</h2>
                    <button id="add-new-rule-btn" class="btn btn-secondary" style="padding: 0.6rem 1rem; font-size: 0.9rem;">+ Nuova Regola</button>
                </div>
                <div id="rule-editor-card" class="card hidden" style="margin-bottom: 2rem; background-color: var(--surface-color-light);">
                    <form id="rule-editor-form">
                        <input type="hidden" id="rule-id">
                        <h3 id="rule-editor-title" class="card-title">Crea Nuova Regola</h3>
                        <div class="space-y-4">
                            <div class="form-group"><label for="rule-name" class="form-label">Nome Regola</label><input type="text" id="rule-name" class="form-input" required placeholder="Es. Assegnazione automatica Box"></div>
                            <div class="form-group"><label for="rule-type" class="form-label">Tipo di Condizione</label><select id="rule-type" class="form-select" required><option value="row_range_classification">Intervallo di Righe</option><option value="text_contains_classification">Testo Contiene</option></select></div>
                            <div id="params-row-range" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div class="form-group"><label for="rule-start-row" class="form-label">Da Riga (inclusa)</label><input type="number" id="rule-start-row" class="form-input" min="1"></div><div class="form-group"><label for="rule-end-row" class="form-label">A Riga (inclusa)</label><input type="number" id="rule-end-row" class="form-input" min="1"></div></div></div>
                            <div id="params-text-contains" class="hidden space-y-4"><div class="form-group"><label for="rule-target-column" class="form-label">Nella Colonna</label><select id="rule-target-column" class="form-select"><option value="">Caricamento colonne...</option></select></div><div class="form-group"><label for="rule-search-text" class="form-label">Testo da Cercare</label><input type="text" id="rule-search-text" class="form-input" placeholder="Es. BOX, Giardino"></div></div>
                            <hr style="border-color: var(--surface-color); margin: 1rem 0;">
                            <div class="form-group"><label for="rule-classification" class="form-label">Azione: Assegna al Gruppo</label><select id="rule-classification" class="form-select" required><option value="">Caricamento gruppi...</option></select></div>
                            <div id="new-group-container" class="form-group hidden" style="margin-top: 0.5rem;"><label for="rule-new-group-name" class="form-label">Nome Nuovo Gruppo</label><input type="text" id="rule-new-group-name" class="form-input" placeholder="Digita il nome del nuovo gruppo"></div>
                        </div>
                        <div class="flex justify-end gap-4 mt-4"><button type="button" id="cancel-rule-edit-btn" class="btn btn-secondary">Annulla</button><button type="submit" class="btn btn-primary">Salva Regola</button></div>
                    </form>
                </div>
                <div id="group-rules-list" class="list-container"><p>Caricamento regole...</p></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderUserManagement = () => `
            ${renderHeader('Gestione Utenti')}
            <main>
                <div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Crea Nuovo Utente</h3>
                    <div id="admin-create-user-message" class="message-box"></div>
                    <form id="admin-create-user-form" class="space-y-4">
                        <div class="form-group">
                            <label for="admin-email" class="form-label">Email</label>
                            <input id="admin-email" type="email" required class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="admin-password" class="form-label">Password Temporanea</label>
                            <input id="admin-password" type="password" required class="form-input">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="admin-nome" class="form-label">Nome</label><input id="admin-nome" type="text" required class="form-input"></div>
                            <div class="form-group"><label for="admin-cognome" class="form-label">Cognome</label><input id="admin-cognome" type="text" required class="form-input"></div>
                        </div>
                        <div class="form-group"><label for="admin-tipo-utente" class="form-label">Tipo di Utente</label>
                            <select id="admin-tipo-utente" required class="form-select">
                                <option value="">Seleziona...</option>
                                <option value="condomino">Condomino</option>
                                <option value="amministratore">Amministratore</option>
                                <option value="custode">Custode</option>
                                <option value="consigliere">Consigliere</option>
                                <option value="fornitore">Fornitore</option>
                                <option value="supervisore">Supervisore</option>
                                <option value="adm">Admin (ADM)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="admin-appartamento" class="form-label">Appartamento</label><input id="admin-appartamento" type="text" class="form-input"></div>
                            <div class="form-group"><label for="admin-millesimi" class="form-label">Millesimi</label><input id="admin-millesimi" type="number" step="0.01" class="form-input"></div>
                        </div>
                        <div class="form-group"><label for="admin-telefono" class="form-label">Telefono</label><input id="admin-telefono" type="tel" class="form-input"></div>
                        <div class="flex justify-end pt-2">
                           <button type="submit" class="btn btn-primary">Crea Utente</button>
                        </div>
                    </form>
                </div>

                <h2 class="section-title">Elenco Utenti Esistenti</h2>
                <div id="user-list-container" class="list-container">
                    <p>Caricamento utenti...</p>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderImpostazioniSondaggi = () => `
            ${renderHeader('Impostazione Sondaggi')}
            <main>
                <div class="card">
                    <h3 class="card-title">Chi può creare sondaggi</h3>
                    <div id="poll-settings-message" class="message-box"></div>
                    <form id="poll-settings-form" class="space-y-4">
                        <div class="form-group">
                            <label class="property-selection-item" style="background-color: var(--surface-color-light); cursor: pointer;">
                                <input type="radio" name="pollAuth" value="option1" style="width: 20px; height: 20px; accent-color: var(--accent-color);">
                                <span style="flex-grow: 1;">Solo Supervisore, Amministratore e Consiglieri</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="property-selection-item" style="background-color: var(--surface-color-light); cursor: pointer;">
                                <input type="radio" name="pollAuth" value="option2" style="width: 20px; height: 20px; accent-color: var(--accent-color);">
                                <span style="flex-grow: 1;">Tutti (Supervisore, Amministratore, Consiglieri, Condomini)</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="property-selection-item" style="background-color: var(--surface-color-light); cursor: pointer;">
                                <input type="radio" name="pollAuth" value="option3" style="width: 20px; height: 20px; accent-color: var(--accent-color);">
                                <span style="flex-grow: 1;">Solo Supervisore e Consiglieri</span>
                            </label>
                        </div>
                        <div class="flex justify-end pt-2">
                           <button type="submit" class="btn btn-primary">Salva Impostazioni</button>
                        </div>
                    </form>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const setupImpostazioniSondaggiHandlers = async () => {
            const form = document.getElementById('poll-settings-form');
            if (!form) return;

            const messageBox = document.getElementById('poll-settings-message');
            const settingsRef = doc(db, "settings", "pollCreationAuthorization");

            // Load current setting
            try {
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    const setting = docSnap.data().setting;
                    const radio = form.querySelector(`input[name="pollAuth"][value="${setting}"]`);
                    if (radio) radio.checked = true;
                } else {
                    // Default to option 2 if not set
                    const radio = form.querySelector('input[name="pollAuth"][value="option2"]');
                    if (radio) radio.checked = true;
                }
            } catch (error) {
                console.error("Error loading poll settings:", error);
                messageBox.className = 'message-box error';
                messageBox.textContent = 'Errore nel caricamento delle impostazioni.';
                messageBox.style.display = 'block';
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const selectedOption = formData.get('pollAuth');
                
                if (!selectedOption) {
                    alert('Seleziona un\'opzione.');
                    return;
                }

                try {
                    await setDoc(settingsRef, { setting: selectedOption });
                    await logActivity("poll_settings_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { newSetting: selectedOption });
                    
                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'Impostazioni salvate con successo!';
                    messageBox.style.display = 'block';
                    setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
                } catch (error) {
                    console.error("Error saving poll settings:", error);
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore nel salvataggio: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });
        };

        const renderCurrentPage = () => {
            const app = document.getElementById('app');
            if (currentPage === 'login') {
                app.innerHTML = renderLoginPage();
                setupLoginHandlers();
                return;
            }
            app.innerHTML = `<div style="padding:1rem;">Caricamento...</div>`;
            const userType = userProfile?.tipoUtente;
            
            if (userType === 'custode' && currentPage === 'dashboard') currentPage = 'segnalazioni';

            let content = '';
            switch (currentPage) {
                case 'dashboard': content = renderDashboard(); break;
                case 'bacheca': content = renderBacheca(); break;
                case 'sondaggi': if (userType !== 'custode') { content = renderSondaggiMenu(); } break;
                case 'sondaggi_crea': if (userType !== 'custode') { content = renderSondaggiCrea(); } break;
                case 'sondaggi_elenco': if (userType !== 'custode') { content = renderSondaggiElenco(); } break;
                case 'segnalazioni': content = renderSegnalazioni(); break;
                case 'profilo': content = renderProfilo(); break;
                case 'infoUtili': content = renderInfoUtili(); break;
                case 'numeriUtiliImportati': content = renderNumeriUtiliImportati(); break;
                case 'numeriUtiliManuali': content = renderNumeriUtiliManuali(); break;
                case 'numeriUtiliRubrica': content = renderNumeriUtiliRubrica(); break;
                case 'userManagement': 
                    if (['supervisore', 'adm'].includes(userType)) content = renderUserManagement(); 
                    else navigateTo('dashboard');
                    break;
                case 'gestioneGruppi':
                    if (['supervisore', 'adm'].includes(userType)) content = renderGestioneGruppiMenu();
                    else navigateTo('dashboard');
                    break;
                case 'gestioneGruppi_lista':
                    if (['supervisore', 'adm'].includes(userType)) content = renderGestioneGruppi_Lista();
                    else navigateTo('dashboard');
                    break;
                case 'gestioneGruppi_regole':
                    if (['supervisore', 'adm'].includes(userType)) content = renderGestioneGruppi_Regole();
                    else navigateTo('dashboard');
                    break;
                case 'importazione':
                    if (['supervisore', 'adm'].includes(userType)) content = renderImportazione();
                    else navigateTo('dashboard');
                    break;
                case 'reportPage':
                    content = renderReportPage();
                    break;
                case 'elencoCondomini':
                    content = renderElencoCondomini();
                    break;
                case 'impostazioniSondaggi':
                    if (['supervisore', 'adm'].includes(userType)) content = renderImpostazioniSondaggi();
                    else navigateTo('dashboard');
                    break;
                default: content = renderLoginPage();
            }

            app.innerHTML = content;

            switch (currentPage) {
                case 'elencoCondomini': loadElencoCondomini(); break;
                case 'bacheca': loadCommunications(); setupBachecaHandlers(); break;
                case 'sondaggi': /* No handlers needed for the menu page */ break;
                case 'sondaggi_crea': if (userType !== 'custode') { setupPollHandlers(); } break;
                case 'sondaggi_elenco': if (userType !== 'custode') { loadPolls(); } break;
                case 'segnalazioni': loadReports(); setupReportHandlers(); break;
                case 'profilo': setupProfileHandlers(); break;
                case 'infoUtili': /* No handlers needed for the menu page */ break;
                case 'numeriUtiliImportati':
                case 'numeriUtiliManuali':
                    loadUsefulNumbers(); 
                    setupInfoUtiliHandlers(); 
                    break;
                case 'numeriUtiliRubrica':
                    loadRubricaNumbers();
                    break;
                case 'userManagement': if (['supervisore', 'adm'].includes(userType)) { loadUsers(); setupAdminUserCreationHandler(); } break;
                case 'gestioneGruppi': /* No handlers needed for the menu page */ break;
                case 'gestioneGruppi_lista': if (['supervisore', 'adm'].includes(userType)) { loadPartialCondos(); setupUserManagementHandlers(); } break;
                case 'gestioneGruppi_regole': if (['supervisore', 'adm'].includes(userType)) { loadGroupRules(); setupGestioneGruppiHandlers(); } break;
                case 'importazione': if (['supervisore', 'adm'].includes(userType)) { setupImportazioneHandlers(); } break;
                case 'impostazioniSondaggi': if (['supervisore', 'adm'].includes(userType)) { setupImpostazioniSondaggiHandlers(); } break;
            }

            if (currentPage !== 'login') {
                checkForNewCommunications();
            }
        };

        const setupLoginHandlers = () => {
            let isRegistering = false;
            let localGroupedProperties = {};
            let localPartialCondosList = [];

            const toggleAuthBtn = document.getElementById("toggle-auth");
            const authTitle = document.getElementById("auth-title");
            const authSubmitBtn = document.getElementById("auth-submit");
            const registerFields = document.getElementById("register-fields");
            const authForm = document.getElementById("auth-form");
            const forgotPasswordBtn = document.getElementById("forgot-password");

            const searchInput = document.getElementById('nominativo-search');
            const optionsContainer = document.getElementById('nominativo-options');
            const propertySelectionWrapper = document.getElementById('property-selection-wrapper');
            const propertyItemsContainer = document.getElementById('property-items-container');
            const summaryEl = document.getElementById('selection-summary');

            const findHeader = (headers, keywords) => {
                const lowerCaseKeywords = keywords.map(k => k.toLowerCase());
                return headers.find(header => lowerCaseKeywords.includes(header.toLowerCase()));
            };

            const loadPartialCondosForRegistration = async () => {
                if (localPartialCondosList.length > 0) return;
                try {
                    const q = query(collection(db, "partialCondos"), orderBy("name"));
                    const querySnapshot = await getDocs(q);
                    localPartialCondosList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Errore nel caricamento dei condomini parziali:", error);
                    localPartialCondosList = [];
                }
            };

            const getAutomaticGroup = (interno) => {
                if (!interno || localPartialCondosList.length === 0) return '';
                const lowerInterno = interno.toLowerCase();
                if (/\be\b|\be-/.test(lowerInterno)) {
                    const boxCondo = localPartialCondosList.find(c => c.name.toLowerCase() === 'box');
                    if (boxCondo) return boxCondo.name;
                }
                if (lowerInterno.includes('b11')) {
                    const b11Condo = localPartialCondosList.find(c => c.name.toLowerCase().includes('bellini 11'));
                    if (b11Condo) return b11Condo.name;
                }
                const sortedCondos = [...localPartialCondosList].sort((a, b) => b.name.length - a.name.length);
                for (const condo of sortedCondos) {
                    if (lowerInterno.includes(condo.name.toLowerCase())) return condo.name;
                }
                return '';
            };

            const loadPropertyDataForRegistration = async () => {
                if (Object.keys(localGroupedProperties).length > 0) return;
                try {
                    const q = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) return;
                    
                    const tableData = querySnapshot.docs[0].data().tableData || [];
                    if (tableData.length === 0) return;

                    const headers = Object.keys(tableData[0]);
                    const nominativoHeader = findHeader(headers, ['nominativo']);
                    const apartmentHeader = findHeader(headers, ['interno', 'appartamento', 'unita']);
                    const millesimiHeader = findHeader(headers, ['millesimi', 'quota']);

                    if (!nominativoHeader || !apartmentHeader || !millesimiHeader) {
                        console.error("Intestazioni non trovate!"); return;
                    }
                    
                    localGroupedProperties = {}; // Assicura che lo stato sia pulito
                    tableData.forEach(item => {
                        const nominativo = item[nominativoHeader];
                        if (!nominativo) return;
                        if (!localGroupedProperties[nominativo]) localGroupedProperties[nominativo] = [];
                        localGroupedProperties[nominativo].push({ apartment: item[apartmentHeader], millesimi: item[millesimiHeader] });
                    });
                } catch (error) { console.error("Errore nel caricamento dati per la registrazione:", error); }
            };

            const renderDropdownOptions = (filter = '') => {
                if (!optionsContainer) return;
                const lowerFilter = filter.toLowerCase();
                const filteredNames = Object.keys(localGroupedProperties)
                    .filter(name => name.toLowerCase().includes(lowerFilter))
                    .sort();

                if (filteredNames.length === 0) {
                    optionsContainer.innerHTML = `<div class="custom-dropdown-item" style="cursor:default;">Nessun risultato</div>`;
                } else {
                    optionsContainer.innerHTML = filteredNames.map(name => 
                        `<div class="custom-dropdown-item" data-value="${name}">${name}</div>`
                    ).join('');
                }
                optionsContainer.classList.remove('hidden');
            };

            const selectNominativo = async (name) => {
                if (!searchInput || !optionsContainer) return;
                searchInput.value = name;
                optionsContainer.classList.add('hidden');

                const properties = localGroupedProperties[name];
                propertyItemsContainer.innerHTML = '';
                propertySelectionWrapper.classList.add('hidden');
                summaryEl.innerHTML = 'Seleziona un nominativo per continuare...';

                if (!properties) return;

                await loadPartialCondosForRegistration();
                const groupOptionsHtml = `<option value="">Nessun Gruppo</option>` + localPartialCondosList.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                properties.forEach((prop, index) => {
                    const autoGroup = getAutomaticGroup(prop.apartment);
                    const isMultiProperty = properties.length > 1;
                    const item = document.createElement('div');
                    item.className = 'property-selection-item';
                    item.dataset.apartment = prop.apartment;
                    item.dataset.millesimi = prop.millesimi;
                    item.innerHTML = `
                        <label for="prop-${index}">
                            ${isMultiProperty ? `<input type="checkbox" id="prop-${index}" style="width: 20px; height: 20px; accent-color: var(--accent-color);">` : ''}
                            <span>${prop.apartment} - ${prop.millesimi} ‰</span>
                        </label>
                        <select class="form-select group-select">${groupOptionsHtml.replace(`value="${autoGroup}"`, `value="${autoGroup}" selected`)}</select>
                    `;
                    propertyItemsContainer.appendChild(item);
                });

                propertySelectionWrapper.classList.remove('hidden');
                propertyItemsContainer.addEventListener('change', updateSummary);
                updateSummary();
            };

            const updateSummary = () => {
                const selectedProperties = [];
                propertyItemsContainer.querySelectorAll('.property-selection-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox && !checkbox.checked) return;
                    const groupSelect = item.querySelector('.group-select');
                    selectedProperties.push({
                        interno: item.dataset.apartment,
                        millesimi: parseFloat(item.dataset.millesimi) || 0,
                        gruppo: groupSelect.value
                    });
                });

                if (selectedProperties.length === 0) {
                    summaryEl.innerHTML = '<span style="color:var(--warning);">Seleziona almeno una proprietà.</span>';
                    return;
                }

                let totalMillesimi = selectedProperties.reduce((sum, prop) => sum + prop.millesimi, 0);
                let summaryHtml = '<strong>Unità Selezionate:</strong><ul>';
                selectedProperties.forEach(prop => {
                    summaryHtml += `<li style="list-style-type: disc; margin-left: 20px;">${prop.interno} (${prop.millesimi.toFixed(2)} ‰) - <strong>Gruppo:</strong> ${prop.gruppo || 'N/A'}</li>`;
                });
                summaryHtml += `</ul><hr style="border-color: var(--surface-color); margin: 0.5rem 0;"><strong style="display: flex; justify-content: space-between;"><span>Totale Millesimi:</span><span>${totalMillesimi.toFixed(2)} ‰</span></strong>`;
                summaryEl.innerHTML = summaryHtml;
            };

            // --- Event Listeners ---
            searchInput?.addEventListener('input', () => renderDropdownOptions(searchInput.value));
            searchInput?.addEventListener('focus', () => renderDropdownOptions(searchInput.value));

            optionsContainer?.addEventListener('click', (e) => {
                if (e.target.classList.contains('custom-dropdown-item') && e.target.dataset.value) {
                    selectNominativo(e.target.dataset.value);
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-dropdown-container')) {
                    optionsContainer?.classList.add('hidden');
                }
            });

            toggleAuthBtn?.addEventListener("click", async (event) => {
                event.preventDefault();
                isRegistering = !isRegistering;
                authTitle.textContent = isRegistering ? "Registrati" : "Accedi";
                authSubmitBtn.textContent = isRegistering ? "Registrati" : "Accedi";
                event.target.textContent = isRegistering ? "Accedi" : "Registrati";
                registerFields.classList.toggle("hidden", !isRegistering);
                forgotPasswordBtn.classList.toggle("hidden", isRegistering);
                if (isRegistering) {
                    await loadPropertyDataForRegistration();
                }
            });

            authForm?.addEventListener("submit", async t => {
                t.preventDefault();
                const o = document.getElementById("email").value, n = document.getElementById("password").value, d = document.getElementById("error-message"), r = document.getElementById("success-message");
                d.style.display = "none"; r.style.display = "none";
                try {
                    if (isRegistering) {
                        const t = document.getElementById("confirm-password").value, i = document.getElementById("nome").value, s = document.getElementById("cognome").value, a = document.getElementById("tipo-utente").value, l = document.getElementById("telefono").value;
                        if (n !== t) throw new Error("Le password non coincidono");
                        if (!i || !s || !a) throw new Error("Compila tutti i campi obbligatori.");

                        const propertiesForUser = [];
                        propertyItemsContainer.querySelectorAll('.property-selection-item').forEach(item => {
                            const checkbox = item.querySelector('input[type="checkbox"]');
                            if (checkbox && !checkbox.checked) return;
                            propertiesForUser.push({
                                interno: item.dataset.apartment,
                                millesimi: parseFloat(item.dataset.millesimi) || 0,
                                gruppo: item.querySelector('.group-select').value || ''
                            });
                        });

                        if (propertiesForUser.length === 0) throw new Error("Seleziona almeno una unità immobiliare.");

                        const internosToRegister = propertiesForUser.map(p => p.interno);
                        const usersSnapshot = await getDocs(collection(db, "users"));
                        for (const userDoc of usersSnapshot.docs) {
                            const user = userDoc.data();
                            if (user.proprieta?.some(p => internosToRegister.includes(p.interno))) {
                                throw new Error(`Una delle unità immobiliari selezionate è già registrata.`);
                            }
                        }
                        
                        await register(o, n, { nome: i, cognome: s, tipoUtente: a, telefono: l, proprieta: propertiesForUser });
                        r.textContent = "Registrazione completata! Ora puoi accedere."; r.style.display = "block"; authForm.reset();
                        propertyItemsContainer.innerHTML = '';
                        propertySelectionWrapper.classList.add('hidden');
                        summaryEl.innerHTML = 'Seleziona un nominativo per continuare...';
                    } else { await login(o, n); }
                } catch (p) { d.textContent = p.message; d.style.display = "block"; }
            });
            
            forgotPasswordBtn?.addEventListener("click", async t => {
                t.preventDefault(); const e = document.getElementById("email").value, o = document.getElementById("error-message"), n = document.getElementById("success-message");
                if (!e) { o.textContent = "Inserisci la tua email per reimpostare la password"; o.style.display = "block"; return; }
                try { await resetPassword(e); n.textContent = "Email di reset password inviata!"; n.style.display = "block"; o.style.display = "none"; } catch (d) { o.textContent = d.message; o.style.display = "block"; }
            });

            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget; const targetId = button.dataset.target; const passwordInput = document.getElementById(targetId);
                    const isPassword = passwordInput.type === 'password'; passwordInput.type = isPassword ? 'text' : 'password';
                    button.innerHTML = isPassword ? eyeSlashIcon : eyeIcon;
                });
            });
        };

        const setupBachecaHandlers=()=>{const e=document.getElementById("create-communication-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("comm-title"),n=document.getElementById("comm-content"),d=document.getElementById("publish-comm-btn"),i=o.value.trim(),r=n.value.trim();if(!i||!r)return alert("Compila titolo e messaggio.");d.disabled=!0,d.textContent="...";try{await addDoc(collection(db,"communications"),{title:i,content:r,createdBy:`${userProfile.nome} ${userProfile.cognome}`,createdById:currentUser.uid,createdAt:serverTimestamp()}),await logActivity("communication_posted",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:i}),e.reset()}catch(c){console.error("Errore:",c),alert("Si è verificato un errore.")}finally{d.disabled=!1,d.textContent="Pubblica"}})};
        const setupPollHandlers = () => {
            const form = document.getElementById("create-poll-form");
            if (!form) return;
            const optionsList = document.getElementById("poll-options-list");
            const addOptionBtn = document.getElementById("add-poll-option");

            function addOptionInput(value = "") {
                const div = document.createElement("div");
                div.className = "flex items-center gap-2";
                div.innerHTML = `<input type="text" class="form-input" style="flex:1" required placeholder="Testo opzione" value="${value}"><button type="button" class="btn-remove-option" style="background:var(--surface-color-light); border:none; color:var(--primary-text); width:36px; height:36px; border-radius:50%; cursor:pointer;">−</button>`;
                div.querySelector(".btn-remove-option").onclick = () => {
                    optionsList.removeChild(div);
                    if (optionsList.childElementCount < 2) addOptionInput();
                };
                optionsList.appendChild(div);
            }

            if (optionsList.childElementCount === 0) {
                addOptionInput();
                addOptionInput();
            }

            addOptionBtn.onclick = e => {
                e.preventDefault();
                addOptionInput();
            };

            form.addEventListener("submit", async (event) => {
                event.preventDefault();
                const messageBox = document.getElementById('poll-creation-message');
                messageBox.style.display = 'none';

                const title = document.getElementById("poll-title").value;
                const description = document.getElementById("poll-description").value;
                const deadlineDate = document.getElementById("poll-deadline").value;
                const deadlineTime = document.getElementById("poll-deadline-time").value;
                const isMultipleChoice = document.getElementById("poll-multiple-choice").checked;
                const optionInputs = form.querySelectorAll('#poll-options-list input[type="text"]');
                const options = Array.from(optionInputs).map(input => input.value.trim()).filter(Boolean).map(text => ({ text: text, votes: 0 }));

                if (options.length < 2) return alert("Inserisci almeno due opzioni.");
                if (!deadlineDate || !deadlineTime) return alert("Inserisci una data e un'ora di scadenza.");

                const deadlineISO = `${deadlineDate}T${deadlineTime}`;
                const deadline = new Date(deadlineISO);

                try {
                    const pollsQuery = query(collection(db, "polls"), orderBy("pollNumber", "desc"), limit(1));
                    const lastPollsSnapshot = await getDocs(pollsQuery);
                    const lastPollNumber = lastPollsSnapshot.empty ? 0 : lastPollsSnapshot.docs[0].data().pollNumber;
                    const newPollNumber = lastPollNumber + 1;

                    const pollData = {
                        pollNumber: newPollNumber,
                        title: title,
                        description: description,
                        options: options,
                        deadline: deadline,
                        multipleChoice: isMultipleChoice,
                        createdBy: `${userProfile.nome} ${userProfile.cognome}`,
                        createdById: currentUser.uid,
                        createdAt: serverTimestamp(),
                        voters: []
                    };

                    await addDoc(collection(db, "polls"), pollData);
                    await logActivity("poll_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { title: title });
                    
                    form.reset();
                    
                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'Sondaggio creato con successo!';
                    messageBox.style.display = 'block';
                    setTimeout(() => { messageBox.style.display = 'none'; }, 4000);

                } catch (error) {
                    console.error("Errore nella creazione del sondaggio:", error);
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });

            form.addEventListener("reset", () => {
                setTimeout(() => {
                    optionsList.innerHTML = "";
                    addOptionInput();
                    addOptionInput();
                }, 0);
            });
        };
        const setupReportHandlers = () => { const e=document.getElementById("create-report-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("report-title").value,n=document.getElementById("report-description").value,i=document.getElementById("report-category").value,d=document.getElementById("report-priority").value,r=document.getElementById("report-location").value;if(!o||!n||!i||!d||!r)return alert("Compila tutti i campi.");const c={title:o,description:n,category:i,priority:d,location:r,status:"aperta",createdBy:`${userProfile.nome} ${userProfile.cognome}`,createdById:currentUser.uid,createdAt:serverTimestamp()},l=document.getElementById("report-recipient");l&&l.value?c.recipientType=l.value:c.recipientType="management";try{await addDoc(collection(db,"reports"),c),await logActivity("report_created",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{title:o,priority:d}),e.reset()}catch(a){console.error("Errore:",a)}})};
        const setupProfileHandlers=()=>{const e=document.getElementById("profile-form");e?.addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("profile-nome").value,n=document.getElementById("profile-cognome").value,d=document.getElementById("profile-telefono").value;try{await updateDoc(doc(db,"users",currentUser.uid),{nome:o,cognome:n,telefono:d}),await loadUserProfile(currentUser),showProfileMessage("success","Profilo aggiornato!")}catch(m){showProfileMessage("error",`Errore: ${m.message}`)}})};

        const setupInfoUtiliHandlers = () => {
            const manualForm = document.getElementById('add-useful-number-form');
            if (manualForm) {
                manualForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const title = document.getElementById('nu-title').value.trim();
                    const company = document.getElementById('nu-company').value.trim();
                    const number = document.getElementById('nu-number').value.trim();
                    const number2 = document.getElementById('nu-number-2').value.trim();
                    if (!title || !number) {
                        alert('I campi "Intervento richiesto" e "1 num. Telefonico" sono obbligatori.');
                        return;
                    }
                    try {
                        await addDoc(collection(db, 'usefulNumbers'), { title, company, number, number2, createdBy: currentUser.uid, createdAt: serverTimestamp() });
                        await logActivity("useful_number_added", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { title });
                        manualForm.reset();
                    } catch (error) {
                        console.error("Errore nell'aggiunta del numero utile:", error);
                        alert("Si è verificato un errore.");
                    }
                });
            }

            const triggerBtn = document.getElementById('trigger-phone-import-btn');
            const fileInput = document.getElementById('info-utili-phone-import-input');
            const messageBox = document.getElementById('info-utili-import-message');
            if (triggerBtn && fileInput && messageBox) {
                triggerBtn.addEventListener('click', () => fileInput.click());

                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    messageBox.className = 'message-box';
                    messageBox.textContent = 'Lettura del file in corso...';
                    messageBox.style.display = 'block';
                    triggerBtn.disabled = true;
                    triggerBtn.textContent = 'Caricamento...';
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            if (jsonData.length === 0) throw new Error("Il file Excel è vuoto o non valido.");
                            messageBox.textContent = 'Salvataggio dei dati...';
                            await addDoc(collection(db, "importedPhoneNumbers"), {
                                fileName: file.name,
                                tableData: jsonData,
                                uploadedBy: currentUser.uid,
                                uploadedAt: serverTimestamp()
                            });
                            await logActivity("phone_data_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { fileName: file.name, source: 'infoUtiliPage' });

                            messageBox.className = 'message-box success';
                            messageBox.textContent = 'Importazione completata con successo!';
                            setTimeout(() => { messageBox.style.display = 'none'; }, 4000);

                        } catch (err) {
                            messageBox.className = 'message-box error';
                            messageBox.textContent = `Errore: ${err.message}`;
                        } finally {
                            fileInput.value = '';
                            triggerBtn.disabled = false;
                            triggerBtn.textContent = 'Importa Nuovo File';
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }
        };

        const applyClassificationRules = (tableData, rules) => {
            if (!rules || rules.length === 0 || !tableData || tableData.length === 0) {
                return tableData;
            }
            const headers = Object.keys(tableData[0]);
            const groupHeader = headers.find(h => h.toLowerCase() === 'raggruppamento');
            if (!groupHeader) return tableData;

            tableData.forEach((row, index) => {
                const excelRowNumber = index + 2;
                let classificationApplied = false;
                for (const rule of rules) {
                    if (classificationApplied) break;
                    let match = false;
                    if (rule.type === 'row_range_classification') {
                        if (excelRowNumber >= rule.params.startRow && excelRowNumber <= rule.params.endRow) {
                            match = true;
                        }
                    } else if (rule.type === 'text_contains_classification') {
                        const cellValue = row[rule.params.targetColumn] || '';
                        if (cellValue.toString().toLowerCase().includes(rule.params.searchText.toLowerCase())) {
                            match = true;
                        }
                    }
                    if (match) {
                        row[groupHeader] = rule.params.classification;
                        classificationApplied = true;
                    }
                }
            });
            return tableData;
        };

        const setupImportazioneHandlers = async () => {
            let partialCondosList = [];
            let activeRules = [];

            const loadPrerequisites = async () => {
                try {
                    const condosQuery = query(collection(db, "partialCondos"), orderBy("name"));
                    const rulesQuery = query(collection(db, "groupRules"), where("isActive", "==", true));
                    const [condosSnapshot, rulesSnapshot] = await Promise.all([
                        getDocs(condosQuery),
                        getDocs(rulesQuery)
                    ]);
                    partialCondosList = condosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    activeRules = rulesSnapshot.docs.map(doc => doc.data());
                } catch (error) {
                    console.error("Errore nel caricamento di gruppi e regole:", error);
                    partialCondosList = [];
                    activeRules = [];
                }
            };

            const generateTableHTML = (data, isPreview = false) => {
                if (!data || data.length === 0) return '<p style="color:var(--secondary-text);">Nessun dato da visualizzare.</p>';
                const groupOptionsHtml = `<option value="">Nessun Gruppo</option>` + partialCondosList.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                let tableHTML = `<table class="data-table" id="millesimi-preview-table">`;
                const headers = Object.keys(data[0]);
                tableHTML += '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
                data.forEach(row => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        const cellValue = row[header] !== undefined ? row[header] : '';
                        if (isPreview && header.toLowerCase() === 'raggruppamento') {
                            const selectedGroupOptions = groupOptionsHtml.replace(`value="${cellValue}"`, `value="${cellValue}" selected`);
                            tableHTML += `<td><select class="form-select" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">${selectedGroupOptions}</select></td>`;
                        } else {
                            tableHTML += `<td>${cellValue}</td>`;
                        }
                    });
                    tableHTML += '</tr>';
                });
                return tableHTML + '</tbody></table>';
            };

            const convertArrayOfArraysToObjects = (data) => {
                const headers = data[0].map(h => h.toString().trim());
                if (!headers.map(h => h.toLowerCase()).includes('raggruppamento')) {
                    headers.push('Raggruppamento');
                    for (let i = 1; i < data.length; i++) {
                        data[i].push('');
                    }
                }
                return data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] !== undefined ? row[index] : '';
                    });
                    return obj;
                });
            };

            const fileInputMillesimi = document.getElementById('excel-file-input-millesimi');
            const tableContainerMillesimi = document.getElementById('excel-table-container-millesimi');
            const messageBoxMillesimi = document.getElementById('message-import-millesimi');
            const saveBtnContainerMillesimi = document.getElementById('save-button-container-millesimi');
            const saveBtnMillesimi = document.getElementById('save-imported-data-btn-millesimi');
            let millesimiFileName = '';

            const loadLatestMillesimiData = async () => {
                const q = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const docData = snapshot.docs[0].data();
                    let data = docData.tableData;
                    data = applyClassificationRules(data, activeRules);
                    tableContainerMillesimi.innerHTML = generateTableHTML(data, true);
                    saveBtnContainerMillesimi.classList.remove('hidden');
                    millesimiFileName = docData.fileName || 'dati_esistenti.xlsx';
                } else {
                    tableContainerMillesimi.innerHTML = '<p style="color:var(--secondary-text);">Nessun dato anagrafico ancora importato.</p>';
                    saveBtnContainerMillesimi.classList.add('hidden');
                }
            };

            fileInputMillesimi.addEventListener('change', (event) => {
                const file = event.target.files[0];
                millesimiFileName = '';
                saveBtnContainerMillesimi.classList.add('hidden'); messageBoxMillesimi.style.display = 'none';
                if (!file) { loadLatestMillesimiData(); return; }
                millesimiFileName = file.name;
                tableContainerMillesimi.innerHTML = '<p>Caricamento anteprima...</p>';
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        if (jsonData.length < 2) throw new Error("Il file deve contenere almeno un'intestazione e una riga di dati.");
                        let dataAsObjects = convertArrayOfArraysToObjects(jsonData);
                        dataAsObjects = applyClassificationRules(dataAsObjects, activeRules);
                        tableContainerMillesimi.innerHTML = generateTableHTML(dataAsObjects, true);
                        saveBtnContainerMillesimi.classList.remove('hidden');
                    } catch (err) {
                        messageBoxMillesimi.className = 'message-box error';
                        messageBoxMillesimi.textContent = `Errore: ${err.message}`;
                        messageBoxMillesimi.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            saveBtnMillesimi.addEventListener('click', async () => {
                const previewTable = document.getElementById('millesimi-preview-table');
                if (!previewTable) return;
                saveBtnMillesimi.disabled = true; saveBtnMillesimi.textContent = 'Salvataggio...';
                try {
                    const headers = Array.from(previewTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    const raggruppamentoIndex = headers.findIndex(h => h.toLowerCase() === 'raggruppamento');
                    const tableData = Array.from(previewTable.querySelectorAll('tbody tr')).map(tr => {
                        const rowObject = {};
                        Array.from(tr.cells).forEach((td, index) => {
                            const header = headers[index];
                            if (index === raggruppamentoIndex) {
                                const select = td.querySelector('select');
                                rowObject[header] = select ? select.value : '';
                            } else {
                                rowObject[header] = td.textContent.trim();
                            }
                        });
                        return rowObject;
                    });
                    if (tableData.length === 0) throw new Error("Nessun dato da salvare.");
                    await addDoc(collection(db, "importedData"), {
                        fileName: millesimiFileName,
                        tableData: tableData,
                        uploadedBy: currentUser.uid,
                        uploadedAt: serverTimestamp()
                    });
                    await logActivity("data_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { fileName: millesimiFileName });
                    fileInputMillesimi.value = '';
                    saveBtnContainerMillesimi.classList.add('hidden');
                    messageBoxMillesimi.className = 'message-box success';
                    messageBoxMillesimi.textContent = 'Dati salvati con successo!';
                    messageBoxMillesimi.style.display = 'block';
                    setTimeout(() => { messageBoxMillesimi.style.display = 'none'; }, 3000);
                    await loadLatestMillesimiData();
                } catch (error) {
                    messageBoxMillesimi.className = 'message-box error';
                    messageBoxMillesimi.textContent = `Errore durante il salvataggio: ${error.message}`;
                    messageBoxMillesimi.style.display = 'block';
                } finally {
                    saveBtnMillesimi.disabled = false; saveBtnMillesimi.textContent = 'Salva Dati Anagrafica';
                }
            });

            const fileInputPhones = document.getElementById('excel-file-input-phones');
            const tableContainerPhones = document.getElementById('excel-table-container-phones');
            const messageBoxPhones = document.getElementById('message-import-phones');
            const saveBtnContainerPhones = document.getElementById('save-button-container-phones');
            const saveBtnPhones = document.getElementById('save-imported-data-btn-phones');
            let phoneDataToSave = null;
            let phoneFileNameForSave = '';

            const loadLatestPhoneData = async () => {
                const q = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data().tableData;
                    tableContainerPhones.innerHTML = generateTableHTML(data);
                } else {
                    tableContainerPhones.innerHTML = '<p style="color:var(--secondary-text);">Nessun numero utile ancora importato.</p>';
                }
            };

            fileInputPhones.addEventListener('change', (event) => {
                const file = event.target.files[0];
                phoneDataToSave = null; phoneFileNameForSave = '';
                saveBtnContainerPhones.classList.add('hidden'); messageBoxPhones.style.display = 'none';
                if (!file) { loadLatestPhoneData(); return; }
                phoneFileNameForSave = file.name;
                tableContainerPhones.innerHTML = '<p>Caricamento anteprima...</p>';
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (jsonData.length === 0) throw new Error("Il file è vuoto.");
                        phoneDataToSave = jsonData;
                        tableContainerPhones.innerHTML = generateTableHTML(jsonData);
                        saveBtnContainerPhones.classList.remove('hidden');
                    } catch (err) {
                        messageBoxPhones.className = 'message-box error';
                        messageBoxPhones.textContent = `Errore: ${err.message}`;
                        messageBoxPhones.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            saveBtnPhones.addEventListener('click', async () => {
                if (!phoneDataToSave) return;
                saveBtnPhones.disabled = true; saveBtnPhones.textContent = 'Salvataggio...';
                try {
                    await addDoc(collection(db, "importedPhoneNumbers"), {
                        fileName: phoneFileNameForSave,
                        tableData: phoneDataToSave,
                        uploadedBy: currentUser.uid,
                        uploadedAt: serverTimestamp()
                    });
                    await logActivity("phone_data_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { fileName: phoneFileNameForSave });
                    fileInputPhones.value = '';
                    saveBtnContainerPhones.classList.add('hidden');
                    await loadLatestPhoneData();
                } catch (error) {
                    messageBoxPhones.className = 'message-box error';
                    messageBoxPhones.textContent = 'Errore durante il salvataggio.';
                    messageBoxPhones.style.display = 'block';
                } finally {
                    saveBtnPhones.disabled = false; saveBtnPhones.textContent = 'Salva Numeri Utili';
                }
            });

            await loadPrerequisites();
            await Promise.all([loadLatestMillesimiData(), loadLatestPhoneData()]);
        };

        const setupUserManagementHandlers = () => {
            const form = document.getElementById('create-partial-condo-form');
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('partial-condo-name');
                const name = nameInput.value.trim();
                if (!name) return;
                try {
                    await addDoc(collection(db, 'partialCondos'), {
                        name: name,
                        createdBy: currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    await logActivity("partial_condo_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { name: name });
                    nameInput.value = '';
                } catch (error) {
                    console.error("Errore nella creazione del condominio parziale:", error);
                    alert("Si è verificato un errore.");
                }
            });
        };

        const setupAdminUserCreationHandler = () => {
            const form = document.getElementById('admin-create-user-form');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                const profileData = {
                    nome: document.getElementById('admin-nome').value,
                    cognome: document.getElementById('admin-cognome').value,
                    tipoUtente: document.getElementById('admin-tipo-utente').value,
                    proprieta: [],
                    telefono: document.getElementById('admin-telefono').value
                };
                const appartamento = document.getElementById('admin-appartamento').value;
                const millesimi = parseFloat(document.getElementById('admin-millesimi').value);
                if (appartamento && !isNaN(millesimi)) {
                    profileData.proprieta.push({ interno: appartamento, millesimi: millesimi, gruppo: '' });
                }
                const messageBox = document.getElementById('admin-create-user-message');
                messageBox.style.display = 'none';
                try {
                    if (!profileData.nome || !profileData.cognome || !profileData.tipoUtente) {
                        throw new Error('Nome, Cognome e Tipo Utente sono obbligatori.');
                    }
                    await register(email, password, profileData);
                    messageBox.className = 'message-box success';
                    messageBox.textContent = `Utente ${email} creato con successo!`;
                    messageBox.style.display = 'block';
                    form.reset();
                } catch (error) {
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });
        };
        
        const loadPartialCondos = () => {
            const listEl = document.getElementById('partial-condos-list');
            if (!listEl) return;
            const q = query(collection(db, "partialCondos"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listEl.innerHTML = `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessun gruppo creato.</p>`;
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(docSnap => {
                    const condo = docSnap.data();
                    return `
                    <div class="list-item">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 14h-2v2h2v-2m4-4h-2v2h2V10m0-4h-2v2h2V6M12 2L2 7v13h20V7L12 2z"/></svg></div>
                        <div class="list-item-content">
                            <div class="title">${condo.name}</div>
                        </div>
                        <div class="list-item-action">
                            <button onclick="deletePartialCondo('${docSnap.id}')" class="btn" style="background:var(--danger); color:white; padding: 0.4rem 0.8rem; font-size:0.8rem;">Elimina</button>
                        </div>
                    </div>
                    `;
                }).join('');
            });
        };

        const deletePartialCondo = async (id) => {
            if (!confirm('Sei sicuro di voler eliminare questo gruppo? L\'azione è irreversibile.')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'partialCondos', id));
                await logActivity("partial_condo_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedId: id });
            } catch (error) {
                console.error("Errore durante l'eliminazione:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        const toggleGroupListVisibility = () => {
            const list = document.getElementById('partial-condos-list');
            const chevron = document.getElementById('group-list-chevron');
            if (!list || !chevron) return;
            const isHiding = list.style.display === 'none';
            if (isHiding) {
                list.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                list.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        };

        let groupRulesUnsubscribe = null;
        let partialCondosForRules = [];
        let excelHeadersForRules = [];

        const openRuleEditor = (rule = null) => {
            const card = document.getElementById('rule-editor-card');
            const form = document.getElementById('rule-editor-form');
            const title = document.getElementById('rule-editor-title');
            const classificationSelect = document.getElementById('rule-classification');
            const columnSelect = document.getElementById('rule-target-column');
            classificationSelect.innerHTML = '<option value="">Seleziona un gruppo...</option>' +
                partialCondosForRules.map(condo => `<option value="${condo.name}">${condo.name}</option>`).join('') +
                '<option value="__CREATE_NEW__" style="font-weight:bold; color:var(--accent-color);">++ Crea nuovo gruppo... ++</option>';
            columnSelect.innerHTML = '<option value="">Seleziona colonna...</option>' +
                excelHeadersForRules.map(header => `<option value="${header}">${header}</option>`).join('');
            if (rule) {
                title.textContent = 'Modifica Regola';
                form.querySelector('#rule-id').value = rule.id;
                form.querySelector('#rule-name').value = rule.name;
                form.querySelector('#rule-type').value = rule.type;
                classificationSelect.value = rule.params.classification;
                if (rule.type === 'row_range_classification') {
                    form.querySelector('#rule-start-row').value = rule.params.startRow;
                    form.querySelector('#rule-end-row').value = rule.params.endRow;
                } else if (rule.type === 'text_contains_classification') {
                    columnSelect.value = rule.params.targetColumn;
                    form.querySelector('#rule-search-text').value = rule.params.searchText;
                }
            } else {
                title.textContent = 'Crea Nuova Regola';
                form.reset();
                form.querySelector('#rule-id').value = '';
            }
            const event = new Event('change');
            form.querySelector('#rule-type').dispatchEvent(event);
            classificationSelect.dispatchEvent(event);
            card.classList.remove('hidden');
        };

        const closeRuleEditor = () => {
            const card = document.getElementById('rule-editor-card');
            card.classList.add('hidden');
            document.getElementById('rule-editor-form').reset();
        };

        const saveGroupRule = async (event) => {
            event.preventDefault();
            const form = event.target;
            const ruleId = form.querySelector('#rule-id').value;
            const ruleName = form.querySelector('#rule-name').value.trim();
            const ruleType = form.querySelector('#rule-type').value;
            let classification = form.querySelector('#rule-classification').value;
            if (!ruleName) { alert('Il nome della regola è obbligatorio.'); return; }
            if (classification === '__CREATE_NEW__') {
                const newGroupNameInput = form.querySelector('#rule-new-group-name');
                const newGroupName = newGroupNameInput.value.trim();
                if (!newGroupName) {
                    alert('Inserisci un nome per il nuovo gruppo.');
                    newGroupNameInput.focus();
                    return;
                }
                try {
                    await addDoc(collection(db, 'partialCondos'), { name: newGroupName, createdBy: currentUser.uid, createdAt: serverTimestamp() });
                    classification = newGroupName;
                } catch (error) {
                    console.error("Errore nella creazione del gruppo:", error);
                    alert("Si è verificato un errore nella creazione del nuovo gruppo.");
                    return;
                }
            }
            if (!classification) { alert('Seleziona un gruppo a cui assegnare la classificazione.'); return; }
            const ruleData = { name: ruleName, type: ruleType, params: {}, isActive: true, updatedAt: serverTimestamp() };
            if (ruleType === 'row_range_classification') {
                const startRow = parseInt(form.querySelector('#rule-start-row').value, 10);
                const endRow = parseInt(form.querySelector('#rule-end-row').value, 10);
                if (!startRow || !endRow) { alert('Specifica un intervallo di righe valido.'); return; }
                if (startRow > endRow) { alert('La riga di inizio non può essere maggiore della riga di fine.'); return; }
                ruleData.params = { startRow, endRow, classification };
            } else if (ruleType === 'text_contains_classification') {
                const targetColumn = form.querySelector('#rule-target-column').value;
                const searchText = form.querySelector('#rule-search-text').value.trim();
                if (!targetColumn || !searchText) { alert('Specifica una colonna e un testo da cercare.'); return; }
                ruleData.params = { targetColumn, searchText, classification };
            }
            try {
                if (ruleId) {
                    await updateDoc(doc(db, 'groupRules', ruleId), ruleData);
                    await logActivity("group_rule_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { ruleName: ruleName });
                } else {
                    ruleData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'groupRules'), ruleData);
                    await logActivity("group_rule_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { ruleName: ruleName });
                }
                closeRuleEditor();
            } catch (error) {
                console.error('Errore nel salvataggio della regola:', error);
                alert('Si è verificato un errore durante il salvataggio.');
            }
        };

        const deleteGroupRule = async (ruleId) => {
            if (!confirm('Sei sicuro di voler eliminare questa regola?')) return;
            try {
                await deleteDoc(doc(db, 'groupRules', ruleId));
                await logActivity("group_rule_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { ruleId: ruleId });
            } catch (error) {
                console.error('Errore eliminazione regola:', error);
                alert('Errore durante l\'eliminazione.');
            }
        };

        const toggleRuleStatus = async (ruleId, currentStatus) => {
            try {
                await updateDoc(doc(db, 'groupRules', ruleId), { isActive: !currentStatus });
            } catch (error) {
                console.error('Errore aggiornamento stato regola:', error);
            }
        };

        const loadGroupRules = () => {
            const listEl = document.getElementById('group-rules-list');
            if (!listEl) return;
            const condosQuery = query(collection(db, "partialCondos"), orderBy("name"));
            const headersQuery = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
            Promise.all([getDocs(condosQuery), getDocs(headersQuery)]).then(([condosSnapshot, headersSnapshot]) => {
                partialCondosForRules = condosSnapshot.docs.map(d => d.data());
                if (!headersSnapshot.empty) {
                    const data = headersSnapshot.docs[0].data().tableData;
                    if (data && data.length > 0) {
                        excelHeadersForRules = Object.keys(data[0]);
                    }
                }
            });
            const rulesQuery = query(collection(db, 'groupRules'), orderBy('createdAt', 'desc'));
            if (groupRulesUnsubscribe) groupRulesUnsubscribe();
            groupRulesUnsubscribe = onSnapshot(rulesQuery, (snapshot) => {
                if (snapshot.empty) {
                    listEl.innerHTML = `<div class="card"><p style="color:var(--secondary-text);">Nessuna regola di classificazione definita.</p></div>`;
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(docSnap => {
                    const rule = { id: docSnap.id, ...docSnap.data() };
                    const params = rule.params;
                    let description = 'Regola non configurata.';
                    if (rule.type === 'row_range_classification') {
                        description = `Se righe da <strong>${params.startRow}</strong> a <strong>${params.endRow}</strong>, assegna a gruppo <strong>${params.classification}</strong>.`;
                    } else if (rule.type === 'text_contains_classification') {
                        description = `Se colonna <strong>${params.targetColumn}</strong> contiene "<strong>${params.searchText}</strong>", assegna a gruppo <strong>${params.classification}</strong>.`;
                    }
                    return `
                    <div class="list-item" style="background-color: var(--surface-color); align-items: flex-start;">
                        <div class="list-item-content" style="padding-top: 0.5rem;">
                            <div class="title" style="font-weight: 600;">${rule.name}</div>
                            <div class="subtitle" style="margin-top: 0.5rem;">${description}</div>
                        </div>
                        <div class="flex flex-col items-end gap-2" style="padding-top: 0.5rem;">
                             <label class="flex items-center gap-2 cursor-pointer" style="font-size: 0.9rem;">
                                <span>${rule.isActive ? 'Attiva' : 'Disattiva'}</span>
                                <div style="position: relative; width: 40px; height: 22px;">
                                    <input type="checkbox" onchange="toggleRuleStatus('${rule.id}', ${rule.isActive})" ${rule.isActive ? 'checked' : ''} class="hidden">
                                    <div style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${rule.isActive ? 'var(--accent-color)' : 'var(--surface-color-light)'}; transition: .4s; border-radius: 34px;"></div>
                                    <div style="position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; transform: ${rule.isActive ? 'translateX(18px)' : 'translateX(0)'};"></div>
                                </div>
                            </label>
                            <div class="flex gap-2 mt-2">
                                <button onclick='openRuleEditor(${JSON.stringify(rule).replace(/'/g, "'")})' class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size:0.8rem;">Modifica</button>
                                <button onclick="deleteGroupRule('${rule.id}')" class="btn" style="background:var(--danger); color:white; padding: 0.4rem 0.8rem; font-size:0.8rem;">Elimina</button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            });
        };

        const setupGestioneGruppiHandlers = () => {
            const addNewRuleBtn = document.getElementById('add-new-rule-btn');
            const cancelRuleBtn = document.getElementById('cancel-rule-edit-btn');
            const ruleForm = document.getElementById('rule-editor-form');
            const ruleTypeSelect = document.getElementById('rule-type');
            const classificationSelect = document.getElementById('rule-classification');
            addNewRuleBtn?.addEventListener('click', () => openRuleEditor(null));
            cancelRuleBtn?.addEventListener('click', closeRuleEditor);
            ruleForm?.addEventListener('submit', saveGroupRule);
            ruleTypeSelect?.addEventListener('change', (e) => {
                const paramsRowRange = document.getElementById('params-row-range');
                const paramsTextContains = document.getElementById('params-text-contains');
                const isRowRange = e.target.value === 'row_range_classification';
                paramsRowRange.classList.toggle('hidden', !isRowRange);
                paramsTextContains.classList.toggle('hidden', isRowRange);
                paramsRowRange.querySelectorAll('input').forEach(i => i.required = isRowRange);
                paramsTextContains.querySelectorAll('input, select').forEach(i => i.required = !isRowRange);
            });
            classificationSelect?.addEventListener('change', (e) => {
                const newGroupContainer = document.getElementById('new-group-container');
                const isCreateNew = e.target.value === '__CREATE_NEW__';
                newGroupContainer.classList.toggle('hidden', !isCreateNew);
                newGroupContainer.querySelector('input').required = isCreateNew;
            });
        };

        const deleteUsefulNumber = async (id) => {
            if (!confirm('Sei sicuro di voler eliminare questo numero?')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'usefulNumbers', id));
                await logActivity("useful_number_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedId: id });
            } catch (error) {
                console.error("Errore durante l'eliminazione del numero:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        const renderNumeriUtiliRubrica = () => `
            ${renderHeader('Rubrica Completa')}
            <main>
                <div class="card">
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 2rem;">
                        Visualizzazione unificata di tutti i contatti, sia quelli importati automaticamente che quelli inseriti manualmente.
                    </p>

                    <h3 class="section-title" style="font-size: 1.1rem;">Contatti da Importazione Automatica</h3>
                    <div id="rubrica-imported-container" class="data-table-container" style="margin-bottom: 2.5rem;">
                        <p style="color:var(--secondary-text);">Caricamento contatti importati...</p>
                    </div>

                    <h3 class="section-title" style="font-size: 1.1rem;">Contatti da Inserimento Manuale</h3>
                    <div id="rubrica-manual-container" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento contatti manuali...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const loadRubricaNumbers = () => {
            const importedContainer = document.getElementById('rubrica-imported-container');
            const manualContainer = document.getElementById('rubrica-manual-container');

            // Carica contatti importati
            if (importedContainer) {
                const qImported = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                onSnapshot(qImported, (snapshot) => {
                    if (snapshot.empty) {
                        importedContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun contatto importato trovato.</p>`;
                        return;
                    }
                    const data = snapshot.docs[0].data().tableData;
                    if (!data || data.length === 0) {
                         importedContainer.innerHTML = `<p style="color:var(--secondary-text);">Il file importato è vuoto.</p>`;
                         return;
                    }
                    const headers = Object.keys(data[0]);
                    let tableHTML = '<table class="data-table"><thead><tr>';
                    headers.forEach(h => tableHTML += `<th>${h}</th>`);
                    tableHTML += '</tr></thead><tbody>';
                    data.forEach(row => {
                        tableHTML += '<tr>';
                        headers.forEach(h => tableHTML += `<td>${row[h] !== undefined ? row[h] : ''}</td>`);
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    importedContainer.innerHTML = tableHTML;
                });
            }

            // Carica contatti manuali
            if (manualContainer) {
                const qManual = query(collection(db, "usefulNumbers"), orderBy("createdAt", "desc"));
                onSnapshot(qManual, (snapshot) => {
                    if (snapshot.empty) {
                        manualContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun contatto inserito manualmente.</p>`;
                        return;
                    }
                    let tableHTML = `<table class="data-table">
                        <thead>
                            <tr>
                                <th>Intervento richiesto</th>
                                <th>Impresa</th>
                                <th>1 num.Telefonico</th>
                                <th>2 num.Telefonico</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    tableHTML += snapshot.docs.map(docSnap => {
                        const contact = docSnap.data();
                        return `<tr>
                                    <td>${contact.title}</td>
                                    <td>${contact.company || '–'}</td>
                                    <td>${contact.number}</td>
                                    <td>${contact.number2 || '–'}</td>
                                </tr>`;
                    }).join('');
                    tableHTML += '</tbody></table>';
                    manualContainer.innerHTML = tableHTML;
                });
            }
        };
        const showProfileMessage=(e,t)=>{const o=document.getElementById("profile-message");o&&(o.className=`message-box ${e}`,o.textContent=t,o.style.display="block",setTimeout(()=>{o.style.display="none"},5e3))};
        
        const showCommunicationDetail = async (commId) => {
            try {
                const commDoc = await getDoc(doc(db, "communications", commId));
                if (commDoc.exists()) {
                    const comm = commDoc.data();
                    const contentHtml = `<p>${comm.content.replace(/\n/g, '<br>')}</p>`;
                    showModal(comm.title, contentHtml);
                }
            } catch (error) {
                console.error("Errore nel caricare la comunicazione:", error);
            }
        };

        const loadCommunications = () => {
            const listEl = document.getElementById("communications-list");
            if (!listEl) return;
            const q = query(collection(db, "communications"), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                listEl.innerHTML = snapshot.empty ? `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessuna comunicazione.</p>` : snapshot.docs.map(docSnap => {
                    const comm = docSnap.data();
                    if (!comm.createdAt) return "";
                    const dateFormatted = comm.createdAt.toDate().toLocaleString("it-IT", { day: "2-digit", month: "short", year: "numeric"});
                    return `
                    <div class="list-item" onclick="showCommunicationDetail('${docSnap.id}')">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <div class="list-item-content">
                            <div class="title">${comm.title}</div>
                            <div class="subtitle">${comm.content.substring(0, 50)}...</div>
                            <div class="subtitle" style="font-size:0.75rem; margin-top:4px;">${comm.createdBy} - ${dateFormatted}</div>
                        </div>
                    </div>`;
                }).join("");
                if (currentPage === 'bacheca' && !snapshot.empty) {
                    localStorage.setItem(`lastSeenComm_${currentUser.uid}`, snapshot.docs[0].data().createdAt.toMillis());
                    updateNotificationUI(false);
                }
            });
        };
        
        const isUserAllowedToVote = (userType, setting) => {
            const allowedRoles = {
                option1: ['supervisore', 'amministratore', 'consigliere'],
                option2: ['supervisore', 'amministratore', 'consigliere', 'condomino'],
                option3: ['supervisore', 'consigliere']
            };
            const roles = allowedRoles[setting] || allowedRoles['option2'];
            return roles.includes(userType);
        };

        const showPollVoters = async (pollId) => {
            try {
                const pollDoc = await getDoc(doc(db, "polls", pollId));
                if (pollDoc.exists()) {
                    const poll = pollDoc.data();
                    let votersHtml;
                    if (poll.voters && poll.voters.length > 0) {
                        const totalVoters = poll.voters.length;
                        const totalMillesimi = poll.voters.reduce((sum, voter) => sum + (parseFloat(voter.millesimi) || 0), 0);

                        const summaryHtml = `
                            <div style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem; font-size: 0.9rem;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>N. Condomini Votanti:</span><span>${totalVoters}</span></div>
                                <hr style="border:none; border-top: 1px solid var(--surface-color); margin: 0.75rem 0;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Tot. Millesimi Votanti:</span><span>${totalMillesimi.toFixed(2)} ‰</span></div>
                            </div>
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Dettaglio per Condomino:</h4>
                        `;

                        const votersListHtml = poll.voters.map(voter => `
                            <div class="voter-item">
                                <span>${voter.name}</span>
                                <span style="color:var(--secondary-text); text-align:right;">
                                    <div>${voter.vote}</div>
                                    <div style="font-size:0.8rem">${(parseFloat(voter.millesimi) || 0).toFixed(2)} ‰</div>
                                </span>
                            </div>
                        `).join('');
                        votersHtml = summaryHtml + votersListHtml;
                    } else {
                        votersHtml = '<p>Nessun voto registrato per questo sondaggio.</p>';
                    }
                    showModal('Dettaglio Voti e Millesimi', votersHtml);
                }
            } catch (error) {
                console.error("Errore nel caricare i votanti:", error);
            }
        };

        const loadPolls = () => {
            const container = document.getElementById("polls-container");
            if (!container) return;
            const settingsRef = doc(db, "settings", "pollAuthorization");
            getDoc(settingsRef).then(settingsSnap => {
                const pollSetting = settingsSnap.exists() ? settingsSnap.data().setting : 'option2';
                const canUserVote = isUserAllowedToVote(userProfile.tipoUtente, pollSetting);
                const q = query(collection(db, "polls"), orderBy("createdAt", "desc"));
                onSnapshot(q, snapshot => {
                    container.innerHTML = snapshot.empty ? `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">Nessun sondaggio disponibile.</p></div>` : snapshot.docs.map(docSnap => {
                        const poll = docSnap.data();
                        if (!poll.deadline) return "";
                        const deadline = poll.deadline.toDate();
                        const isExpired = deadline < new Date();
                        const hasVoted = poll.voters && poll.voters.some(v => v.uid === currentUser.uid);
                        const totalVotes = poll.options.reduce((sum, opt) => sum + (opt.votes || 0), 0);
                        const showVoteUI = !isExpired && canUserVote;
                        
                        const pollTitle = poll.pollNumber ? `Sondaggio N. ${poll.pollNumber}: ${poll.title}` : poll.title;
                        const buttonText = hasVoted ? 'Cambia Voto' : 'Invia Voto';

                        const dateOptions = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                        const creationDate = poll.createdAt ? poll.createdAt.toDate().toLocaleString("it-IT", dateOptions) : 'N/D';
                        const closingDate = poll.deadline ? deadline.toLocaleString("it-IT", dateOptions) : 'N/D';
                        const dateInfoHtml = `
                        <div style="font-size: 0.8rem; color: var(--secondary-text); margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--surface-color-light);">
                            <div><strong>Creato il:</strong> ${creationDate}</div>
                            <div><strong>Scade il:</strong> ${closingDate}</div>
                        </div>`;

                        let optionsHtml = '';
                        if (showVoteUI) {
                            if (poll.multipleChoice) {
                                const voterRecord = poll.voters.find(v => v.uid === currentUser.uid);
                                const previousVotes = hasVoted && voterRecord ? voterRecord.vote.split(', ') : [];
                                const optionsCheckboxes = poll.options.map((option, index) => {
                                    const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                    const isChecked = hasVoted && previousVotes.includes(option.text);
                                    return `
                                    <div>
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                            <span class="font-medium">${option.text}</span>
                                            <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                        </div>
                                        <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                        <label class="flex items-center gap-3 p-3 mt-3 rounded-md cursor-pointer" style="background-color: var(--surface-color-light);">
                                            <input type="checkbox" class="poll-option-checkbox-${docSnap.id}" value="${index}" ${isChecked ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: var(--accent-color);">
                                            <span>Seleziona questa opzione</span>
                                        </label>
                                    </div>`;
                                }).join('');
                                const submitButton = `<button onclick="voteOnPoll('${docSnap.id}')" class="btn btn-primary w-full mt-4">${buttonText}</button>`;
                                optionsHtml = `<div class="space-y-4">${optionsCheckboxes}</div>${submitButton}`;
                            } else {
                                optionsHtml = `<div class="space-y-4">${poll.options.map((option, index) => {
                                    const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                    return `
                                    <div>
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                            <span class="font-medium">${option.text}</span>
                                            <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                        </div>
                                        <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                        <button onclick="voteOnPoll('${docSnap.id}', ${index})" class="btn btn-secondary" style="width:100%; margin-top:0.75rem;">${hasVoted ? 'Vota di nuovo per' : 'Vota per'} "${option.text}"</button>
                                    </div>`;
                                }).join("")}</div>`;
                            }
                        } else {
                            optionsHtml = `<div class="space-y-4">${poll.options.map(option => {
                                const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                return `
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                        <span class="font-medium">${option.text}</span>
                                        <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                    </div>
                                    <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                </div>`;
                            }).join("")}</div>`;
                        }

                        let votingInstructionHtml = '';
                        if (showVoteUI) {
                            let instructionText = poll.multipleChoice ? 'Puoi selezionare più risposte.' : 'Scegli una sola risposta.';
                            if (hasVoted) {
                                instructionText = 'Hai già votato. Puoi modificare la tua scelta qui sotto.';
                            }
                            votingInstructionHtml = `<p class="form-label" style="margin-bottom: 1rem; color: var(--secondary-text);">${instructionText}</p>`;
                        }

                        const actionButtons = [];
                        actionButtons.push(`<button onclick="showPollVoters('${docSnap.id}')" class="btn btn-secondary" style="flex-grow:1;">Mostra Votanti</button>`);
                        
                        if (poll.createdById === currentUser.uid && !isExpired) {
                            actionButtons.push(`<button onclick="deletePoll('${docSnap.id}')" class="btn" style="background:var(--danger); color:white; flex-grow:1;">Elimina</button>`);
                        }
                        const actionButtonsHtml = actionButtons.length > 0 ? `<div class="flex gap-4 mt-4">${actionButtons.join('')}</div>` : '';

                        return `
                        <div class="card" style="padding:1rem; margin-bottom:1rem;">
                            <div class="list-item" style="padding:0; margin-bottom:1rem; cursor:default;">
                                <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                                <div class="list-item-content">
                                    <div class="title">${pollTitle}</div>
                                    <div class="subtitle">${isExpired ? "Sondaggio chiuso" : "Sondaggio attivo"} ${hasVoted ? "· Hai votato" : ""}</div>
                                </div>
                            </div>
                            ${votingInstructionHtml}
                            ${optionsHtml}
                            ${dateInfoHtml}
                            ${actionButtonsHtml}
                        </div>`;
                    }).join("");
                });
            });
        };

        const loadReports = () => {
            const mainContainer = document.getElementById('reports-main-container');
            const secondaryContainer = document.getElementById('reports-secondary-container');
            if (!mainContainer || !secondaryContainer) return;
            const renderReportCardHTML=(e,t)=>{if(!e.createdAt)return"";const o=e.createdAt.toDate().toLocaleString("it-IT",{day:"2-digit",month:"short"});const a=["amministratore","custode","consigliere","fornitore","supervisore", "adm"].includes(userProfile?.tipoUtente);const n=a,d="management"===e.recipientType&&n||e.recipientType===userProfile?.tipoUtente||"consigliere"===e.recipientType&&"consigliere"===userProfile?.tipoUtente;return`<div class="list-item"><div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div><div class="list-item-content"><div class="title">${e.title}</div><div class="subtitle" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.25rem;"><span class="badge ${getPriorityColor(e.priority)}">${e.priority}</span><span class="badge ${getStatusColor(e.status)}">${e.status}</span></div></div>${a&&"chiusa"!==e.status&&d?`<div class="list-item-action"><button onclick="updateReportStatus('${t}','${"aperta"===e.status?"in-corso":"chiusa"}')" class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.8rem;">${"aperta"===e.status?"Prendi":"Chiudi"}</button></div>`:""}</div>`};
            const renderSnapshot=(e,t,o)=>{if(t.empty)return void(e.innerHTML=`<p style="color:var(--secondary-text); padding: 1rem 0;">${o}</p>`);const a=t.docs.sort((e,t)=>{const o=e.data().createdAt?.toMillis()||0,n=t.data().createdAt?.toMillis()||0;return n-o});e.innerHTML=a.map(e=>renderReportCardHTML(e.data(),e.id)).join("")};
            const userType=userProfile.tipoUtente,userId=currentUser.uid,qSent=query(collection(db,"reports"),where("createdById","==",userId));onSnapshot(qSent,s=>renderSnapshot(secondaryContainer,s,"Non hai inviato segnalazioni."));let qToManage;if(["amministratore","custode","consigliere","fornitore", "supervisore", "adm"].includes(userType)){qToManage=query(collection(db,"reports"),orderBy("createdAt","desc"));onSnapshot(qToManage,s=>renderSnapshot(mainContainer,s,"Nessuna segnalazione ricevuta."))}else{qToManage=query(collection(db,"reports"),where("recipientType","in",["management","condomino"]));onSnapshot(qToManage,s=>renderSnapshot(mainContainer,s,"Nessuna segnalazione pubblica."))}
        };

        const deleteUser = async (userId, userName) => {
            if (!confirm(`Sei sicuro di voler eliminare l'utente ${userName}? L'utente verrà rimosso dal sistema e non potrà più accedere. L'azione è irreversibile.`)) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'users', userId));
                await logActivity("user_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedUserId: userId, deletedUserName: userName });
                // Nota: L'eliminazione dell'utente da Firebase Authentication non può essere eseguita in modo sicuro dal client.
                // Richiede una Cloud Function o la riautenticazione dell'utente da eliminare.
                // Eliminando il documento utente da Firestore, l'utente non potrà più caricare il suo profilo e usare l'app.
                loadUsers(); // Ricarica la lista per riflettere il cambiamento
            } catch (error) {
                console.error("Errore durante l'eliminazione dell'utente:", error);
                alert(`Si è verificato un errore: ${error.message}`);
            }
        };

        const updateUser = async (event) => {
            event.preventDefault();
            const form = event.target;
            const userId = form.querySelector('#edit-user-id').value;
            const submitButton = form.querySelector('button[type="submit"]');
            const messageBox = form.querySelector('#edit-user-message');
            
            const updatedData = {
                nome: form.querySelector('#edit-nome').value,
                cognome: form.querySelector('#edit-cognome').value,
                tipoUtente: form.querySelector('#edit-tipo-utente').value,
                telefono: form.querySelector('#edit-telefono').value,
            };

            submitButton.disabled = true;
            submitButton.textContent = 'Salvataggio...';
            messageBox.style.display = 'none';

            try {
                // Nota: la modifica delle proprietà (appartamenti/millesimi) non è inclusa in questo form
                // per semplicità. Viene gestita solo la modifica dei dati principali dell'utente.
                await updateDoc(doc(db, "users", userId), updatedData);
                await logActivity("user_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { updatedUserId: userId, changes: updatedData });
                
                hideModal();
                loadUsers(); // Ricarica la lista per mostrare i dati aggiornati
            } catch (error) {
                console.error("Errore durante l'aggiornamento dell'utente:", error);
                messageBox.className = 'message-box error';
                messageBox.textContent = `Errore: ${error.message}`;
                messageBox.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'Salva Modifiche';
            }
        };

        const openUserEditModal = (user) => {
            // L'oggetto 'user' contiene id, nome, cognome, email, tipoUtente, etc.
            const allRoles = ["condomino", "amministratore", "custode", "consigliere", "fornitore", "supervisore", "adm"];
            const rolesOptions = allRoles.map(role => {
                const capitalizedRole = role.charAt(0).toUpperCase() + role.slice(1);
                return `<option value="${role}" ${user.tipoUtente === role ? 'selected' : ''}>${capitalizedRole}</option>`
            }).join('');

            const modalContent = `
                <form id="edit-user-form" class="space-y-4" onsubmit="updateUser(event)">
                    <input type="hidden" id="edit-user-id" value="${user.id}">
                    <div id="edit-user-message" class="message-box"></div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" value="${user.email || ''}" class="form-input" disabled>
                        <p class="form-label" style="font-size:0.8rem; margin-top:0.25rem;">L'email non può essere modificata.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="edit-nome" class="form-label">Nome</label>
                            <input id="edit-nome" type="text" required class="form-input" value="${user.nome || ''}">
                        </div>
                        <div class="form-group">
                            <label for="edit-cognome" class="form-label">Cognome</label>
                            <input id="edit-cognome" type="text" required class="form-input" value="${user.cognome || ''}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="edit-tipo-utente" class="form-label">Tipo di Utente</label>
                        <select id="edit-tipo-utente" required class="form-select">${rolesOptions}</select>
                    </div>

                    <div class="form-group">
                        <label for="edit-telefono" class="form-label">Telefono</label>
                        <input id="edit-telefono" type="tel" class="form-input" value="${user.telefono || ''}">
                    </div>
                    
                    <div class="flex justify-end gap-4 pt-2">
                       <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                       <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                    </div>
                </form>
            `;

            showModal(`Modifica Utente: ${user.nome} ${user.cognome}`, modalContent);
        };

        const loadUsers = async () => {
            const container = document.getElementById('user-list-container');
            if (!container) return;
            if (!['supervisore', 'adm'].includes(userProfile?.tipoUtente)) {
                container.innerHTML = '<p>Accesso non autorizzato.</p>';
                return;
            }
            try {
                const usersSnapshot = await getDocs(query(collection(db, "users"), orderBy("cognome")));
                if (usersSnapshot.empty) {
                    container.innerHTML = '<p>Nessun utente trovato.</p>';
                } else {
                    container.innerHTML = usersSnapshot.docs.map(docSnap => {
                        const user = docSnap.data();
                        const userId = docSnap.id;
                        const propertiesHtml = user.proprieta && user.proprieta.length > 0
                            ? user.proprieta.map(p => `<li>${p.interno}: ${p.millesimi.toFixed(2)} ‰ ${p.gruppo ? `- <strong>Gruppo:</strong> ${p.gruppo}` : ''}</li>`).join('')
                            : '<li>Nessuna proprietà</li>';
                        
                        // Aggiunta delle icone di modifica ed eliminazione
                        const userObjectString = JSON.stringify({ id: userId, ...user }).replace(/'/g, "&apos;");

                        return `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div class="list-item" style="padding:0; cursor:default; align-items: flex-start;">
                                <div class="list-item-icon" style="margin-top: 0.5rem;"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg></div>
                                <div class="list-item-content" style="padding-top: 0.5rem;">
                                    <div class="title">${user.nome} ${user.cognome}</div>
                                    <div class="subtitle">${user.email} - ${user.tipoUtente}</div>
                                </div>
                                <div class="list-item-action flex gap-2" style="padding-top: 0.5rem;">
                                    <button class="user-action-btn" onclick='openUserEditModal(${userObjectString})' title="Modifica Utente">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    </button>
                                    <button class="user-action-btn" onclick="deleteUser('${userId}', '${user.nome} ${user.cognome}')" title="Elimina Utente">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div style="padding-left: 64px; margin-top: 0.5rem; font-size: 0.9rem;">
                                <strong class="form-label" style="color:var(--primary-text);">Proprietà e Millesimi:</strong>
                                <ul style="list-style-type: disc; margin-left: 20px; color: var(--secondary-text);">
                                   ${propertiesHtml}
                                </ul>
                                <hr style="border-color: var(--surface-color); margin: 0.75rem 0;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Millesimi Totali:</span><span>${(user.millesimiTotali || 0).toFixed(2)} ‰</span></div>
                            </div>
                        </div>`;
                    }).join("");
                }
            } catch (error) {
                console.error("Errore nel caricare gli utenti:", error);
                container.innerHTML = '<p>Errore nel caricamento degli utenti.</p>';
            }
        };

        const loadUsefulNumbers = () => {
            const manualTableBody = document.getElementById('useful-numbers-table-body');
            const importedTableContainer = document.getElementById('imported-numbers-table-container');
            const canManage = ['amministratore', 'supervisore', 'adm'].includes(userProfile?.tipoUtente);
            if (manualTableBody) {
                const qManual = query(collection(db, "usefulNumbers"), orderBy("createdAt", "desc"));
                onSnapshot(qManual, (snapshot) => {
                    if (snapshot.empty) {
                        manualTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:var(--secondary-text);">Nessun contatto inserito.</td></tr>`;
                        return;
                    }
                    manualTableBody.innerHTML = snapshot.docs.map(docSnap => {
                        const contact = docSnap.data();
                        const deleteButtonHtml = canManage ? `<button onclick="deleteUsefulNumber('${docSnap.id}')" class="btn" style="background:var(--danger); color:white; padding: 0.4rem 0.8rem; font-size:0.8rem;">Elimina</button>` : 'N/A';
                        return `<tr><td>${contact.title}</td><td>${contact.company || '–'}</td><td>${contact.number}</td><td>${contact.number2 || '–'}</td><td style="text-align:right;">${deleteButtonHtml}</td></tr>`;
                    }).join('');
                });
            }
            if (importedTableContainer) {
                const qImported = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                onSnapshot(qImported, (snapshot) => {
                    if (snapshot.empty) {
                        importedTableContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun contatto importato trovato.</p>`;
                        return;
                    }
                    const data = snapshot.docs[0].data().tableData;
                    if (!data || data.length === 0) {
                         importedTableContainer.innerHTML = `<p style="color:var(--secondary-text);">Il file importato è vuoto.</p>`;
                         return;
                    }
                    const headers = Object.keys(data[0]);
                    let tableHTML = '<table class="data-table"><thead><tr>';
                    headers.forEach(h => tableHTML += `<th>${h}</th>`);
                    tableHTML += '</tr></thead><tbody>';
                    data.forEach(row => {
                        tableHTML += '<tr>';
                        headers.forEach(h => tableHTML += `<td>${row[h] !== undefined ? row[h] : ''}</td>`);
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    importedTableContainer.innerHTML = tableHTML;
                });
            }
        };

        const voteOnPoll = async (pollId, optionIndex) => {
            try {
                const settingsRef = doc(db, "settings", "pollAuthorization");
                const settingsSnap = await getDoc(settingsRef);
                const pollSetting = settingsSnap.exists() ? settingsSnap.data().setting : "option2";
                if (!isUserAllowedToVote(userProfile.tipoUtente, pollSetting)) {
                    return alert("Non sei autorizzato a votare in questo sondaggio.");
                }

                const pollRef = doc(db, "polls", pollId);
                const pollSnap = await getDoc(pollRef);
                if (!pollSnap.exists()) return;

                const poll = pollSnap.data();
                if (poll.deadline.toDate() < new Date()) return alert("Sondaggio scaduto.");

                const updatedOptions = [...poll.options];
                let updatedVoters = [...poll.voters || []];
                const voterIndex = updatedVoters.findIndex(v => v.uid === currentUser.uid);

                // Se l'utente ha già votato, annulla il suo voto precedente
                if (voterIndex > -1) {
                    const oldVoteRecord = updatedVoters[voterIndex];
                    const oldChoices = oldVoteRecord.vote.split(', ');
                    oldChoices.forEach(oldChoiceText => {
                        const optionToDecrement = updatedOptions.find(opt => opt.text === oldChoiceText);
                        if (optionToDecrement && optionToDecrement.votes > 0) {
                            optionToDecrement.votes -= 1;
                        }
                    });
                    // Rimuovi il vecchio record di voto
                    updatedVoters.splice(voterIndex, 1);
                }

                // Applica il nuovo voto
                let newSelectedOptionsText = [];
                if (typeof optionIndex !== 'undefined') { // Risposta singola
                    updatedOptions[optionIndex].votes = (updatedOptions[optionIndex].votes || 0) + 1;
                    newSelectedOptionsText.push(poll.options[optionIndex].text);
                } else { // Risposta multipla
                    const checkedBoxes = document.querySelectorAll(`.poll-option-checkbox-${pollId}:checked`);
                    if (checkedBoxes.length === 0) return alert("Seleziona almeno un'opzione per votare.");
                    
                    checkedBoxes.forEach(box => {
                        const idx = parseInt(box.value, 10);
                        if (!isNaN(idx) && updatedOptions[idx]) {
                            updatedOptions[idx].votes = (updatedOptions[idx].votes || 0) + 1;
                            newSelectedOptionsText.push(poll.options[idx].text);
                        }
                    });
                }

                // Aggiungi il nuovo record di voto
                const userMillesimi = userProfile?.millesimiTotali || 0;
                updatedVoters.push({
                    uid: currentUser.uid,
                    name: `${userProfile.nome} ${userProfile.cognome}`,
                    vote: newSelectedOptionsText.join(', '),
                    millesimi: userMillesimi
                });

                await updateDoc(pollRef, { options: updatedOptions, voters: updatedVoters });
                await logActivity("poll_voted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    pollTitle: poll.title,
                    option: newSelectedOptionsText.join(', '),
                    isChange: voterIndex > -1
                });

            } catch (error) {
                console.error("Errore nel voto:", error);
                alert("Si è verificato un errore durante il voto.");
            }
        };

        const updateReportStatus=async(e,t)=>{try{await updateDoc(doc(db,"reports",e),{status:t,updatedAt:serverTimestamp()}),await logActivity("report_updated",currentUser.uid,`${userProfile.nome} ${userProfile.cognome}`,{reportId:e,newStatus:t})}catch(o){console.error("Errore nell'aggiornamento:",o)}};
        const updateNotificationUI=e=>{const t=document.getElementById("bacheca-notification-badge");t?.classList.toggle("hidden",!e)};
        const checkForNewCommunications=()=>{if(!currentUser||"custode"===userProfile?.tipoUtente)return;communicationsListener&&communicationsListener();const e=parseInt(localStorage.getItem(`lastSeenComm_${currentUser.uid}`),10)||0,t=new Date(e),o=query(collection(db,"communications"),where("createdAt",">",t));communicationsListener=onSnapshot(o,e=>{updateNotificationUI(!e.empty)})};
        
        window.navigateTo = navigateTo;
        window.navigateBack = navigateBack;
        window.logout = logout;
        window.voteOnPoll = voteOnPoll;
        window.updateReportStatus = updateReportStatus;
        window.showCommunicationDetail = showCommunicationDetail;
        window.showPollVoters = showPollVoters;
        window.deletePartialCondo = deletePartialCondo;
        window.deleteUsefulNumber = deleteUsefulNumber;
        window.openRuleEditor = openRuleEditor;
        window.deleteGroupRule = deleteGroupRule;
        window.toggleRuleStatus = toggleRuleStatus;
       window.toggleGroupListVisibility = toggleGroupListVisibility;
        window.loadElencoCondomini = loadElencoCondomini;
        window.deleteUser = deleteUser;
        window.openUserEditModal = openUserEditModal;
        const deletePoll = async (pollId) => {
            if (!confirm('Sei sicuro di voler eliminare questo sondaggio? L\'azione è irreversibile.')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'polls', pollId));
                await logActivity("poll_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedPollId: pollId });
            } catch (error) {
                console.error("Errore durante l'eliminazione del sondaggio:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        window.updateUser = updateUser;
        window.deletePoll = deletePoll;

        // --- FUNZIONE onAuthStateChanged CORRETTA E ROBUSTA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // L'utente è loggato o si è appena loggato
                currentUser = user;
                await loadUserProfile(user);
                
                const userType = userProfile?.tipoUtente;
                let landingPage = 'dashboard';
                if (userType === 'custode') landingPage = 'segnalazioni';
                
                // Se l'utente si trova sulla pagina di login, lo reindirizziamo alla sua home.
                // Altrimenti (se ha ricaricato la pagina), gli mostriamo la pagina su cui si trovava.
                if (currentPage === 'login' || !currentPage) {
                    navigateTo(landingPage);
                } else {
                    renderCurrentPage();
                }

            } else {
                // L'utente non è loggato o ha appena fatto logout
                if (communicationsListener) {
                    communicationsListener();
                    communicationsListener = null;
                }
                currentUser = null; 
                userProfile = null;
                navigationHistory = []; // Resetta la cronologia al logout
                // Resetta lo stato specifico della registrazione per evitare dati "sporchi"
                groupedProperties = {};
                partialCondosList = [];
                
                // Naviga alla pagina di login in modo pulito
                navigateTo('login');
            }
        });
    </script>
</body>
</html
